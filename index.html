<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Relat√≥rio Individual de Avalia√ß√£o Descritiva (Educa√ß√£o Infantil/Ensino Fundamental I)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 900px;
            margin-top: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .nav-tabs .nav-link {
            font-weight: bold;
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            border-color: #dee2e6 #dee2e6 #fff;
            background-color: #fff;
        }
        .form-label.required::after {
            content: " *";
            color: red;
            font-weight: bold;
        }
        textarea {
            min-height: 120px;
            font-family: Arial, sans-serif;
        }
        /* Estilo para a pr√©-visualiza√ß√£o da logo */
        .logo-upload-box {
            border: 1px dashed #ccc;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        .logo-preview {
            max-width: 100%;
            max-height: 80px;
            display: none; 
            margin-bottom: 5px;
        }
        .logo-placeholder {
            font-size: 30px;
            color: #6c757d;
        }
        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .report-item:last-child {
            border-bottom: none;
        }
        #savedReportsList {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="container"> 
    <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
        
        <div class="text-start">
            <h2 class="text-primary" style="margin-bottom: 0;">Gerador de Relat√≥rio Individual</h2>
            <p class="text-muted" style="font-size: 0.9em; margin-bottom: 0;">Ferramenta para Educa√ß√£o Infantil e Ensino Fundamental I</p>
        </div>
        
        <button id="logoutButton" class="btn btn-danger align-self-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-right me-1" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 1 3.5v9A1.5 1.5 0 0 0 2.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
            </svg>
            Sair
        </button>
        
    </div>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-tab-pane" type="button" role="tab" aria-controls="create-tab-pane" aria-selected="true">‚úçÔ∏è Criar Relat√≥rio</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="saved-tab" data-bs-toggle="tab" data-bs-target="#saved-tab-pane" type="button" role="tab" aria-controls="saved-tab-pane" aria-selected="false">üìö Relat√≥rios Salvos (<span id="savedReportsCount">0</span>)</button>
            </li>
        </ul>

        <div class="tab-content pt-3" id="myTabContent">

            <div class="tab-pane fade show active" id="create-tab-pane" role="tabpanel" aria-labelledby="create-tab" tabindex="0">
                <form id="reportForm">
                    
                    <h5 class="mt-3 mb-3 text-secondary">1. Configura√ß√£o da Escola (Salva Automaticamente)</h5>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="schoolName" placeholder="Escola Tra√ßos e Letras" required disabled>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="schoolAddress" placeholder="Catu/Ba" required disabled>
                        </div>
                        <div class="col-md-4">
                            <div class="logo-upload-box" onclick="document.getElementById('logoUpload').click()">
                                <input type="file" id="logoUpload" accept="image/*" style="display: none;">
                                <img id="logoPreview" class="logo-preview" alt="Pr√©-visualiza√ß√£o da Logo">
                                <span id="logoPlaceholder" class="logo-placeholder">üñºÔ∏è</span>
                                <small class="text-muted" id="logoText">Logo da Escola</small>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="schoolPhone" placeholder=" (71) 98200-2432" required disabled>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="schoolWebsite" placeholder="www.portaltracoseletras.com.br" required disabled>
                        </div>
                    </div>

                    <h5 class="mt-3 mb-3 text-secondary">2. Informa√ß√µes do Aluno/Professor</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="studentName" class="form-label required">Nome Completo do Aluno(a)</label>
                            <input type="text" class="form-control" id="studentName" required>
                        </div>
                        <div class="col-md-3">
                            <label for="studentAge" class="form-label required">Idade/Anos</label>
                            <input type="text" class="form-control" id="studentAge" required placeholder="Ex: 4 anos">
                        </div>
                        <div class="col-md-3">
                            <label for="studentGrade" class="form-label required">S√©rie/Turma</label>
                            <input type="text" class="form-control" id="studentGrade" required placeholder="Ex: Infantil III">
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="schoolYear" class="form-label required">Ano Letivo/Semestre</label>
                            <input type="text" class="form-control" id="schoolYear" required placeholder="Ex: 2024 / I Semestre">
                        </div>
                        <div class="col-md-4">
                            <label for="teacherName" class="form-label required">Nome do Professor(a)</label>
                            <input type="text" class="form-control" id="teacherName" required>
                        </div>
                        <div class="col-md-4">
                            <label for="digitalSignatureText" class="form-label">Texto da Assinatura Digital (Ex: Matr√≠cula, A. Profissional)</label>
                            <input type="text" class="form-control" id="digitalSignatureText" placeholder="Ex: Matr√≠cula 12345/BA">
                        </div>
                    </div>

                    <h5 class="mt-4 mb-3 text-secondary">3. Relato Descritivo Geral do Aluno</h5>
                    <p class="text-muted"><small>Fa√ßa uma introdu√ß√£o descritiva sobre o aluno, seu comportamento, pontos fortes e desafios gerais.</small></p>
                    <div class="mb-4">
                        <label for="studentDevelopment" class="form-label required">Desenvolvimento: Aspectos Gerais e Comportamentais</label>
                        <textarea class="form-control" id="studentDevelopment" required 
                            placeholder="Ex: Jo√£o demonstrou grande evolu√ß√£o na autonomia e na intera√ß√£o com os colegas. √â um aluno curioso e participativo, embora ainda precise de incentivo para desenvolver a coordena√ß√£o motora fina em atividades de desenho e escrita."></textarea>
                    </div>
                    <h5 class="mt-4 mb-3 text-secondary">4. Detalhamento por Campos de Experi√™ncia (BNCC)</h5>
                    <p class="text-muted"><small>Descreva o desenvolvimento da crian√ßa em cada campo de forma detalhada e positiva.</small></p>

                    <div class="mb-3">
                        <label for="devEuOutroNos" class="form-label">O Eu, O Outro e o N√≥s:</label>
                        <textarea class="form-control" id="devEuOutroNos" placeholder="Intera√ß√£o com pares, respeito √†s regras, autonomia, identidade."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="devEscutaFala" class="form-label">Escuta, Fala, Pensamento e Imagina√ß√£o:</label>
                        <textarea class="form-control" id="devEscutaFala" placeholder="Express√£o oral, compreens√£o de hist√≥rias, vocabul√°rio, formula√ß√£o de perguntas."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="devEspacoTempo" class="form-label">Espa√ßo, Tempo, Quantidade, Rela√ß√µes e Transforma√ß√µes:</label>
                        <textarea class="form-control" id="devEspacoTempo" placeholder="No√ß√µes espaciais e temporais, contagem, compara√ß√£o de objetos, racioc√≠nio l√≥gico-matem√°tico."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="devCorpoGesto" class="form-label">Corpo, Gesto e Movimento:</label>
                        <textarea class="form-control" id="devCorpoGesto" placeholder="Coordena√ß√£o motora ampla e fina, equil√≠brio, lateralidade, uso do corpo para expressar emo√ß√µes."></textarea>
                    </div>

                    <div class="mb-4">
                        <label for="devTracosSons" class="form-label">Tra√ßos, Sons, Cores e Formas:</label>
                        <textarea class="form-control" id="devTracosSons" placeholder="Interesse por artes visuais, m√∫sica, formas geom√©tricas, percep√ß√£o sensorial."></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label for="otherTeachers" class="form-label">Outros Professores Envolvidos (Opcional, n√£o aparece no PDF, apenas para registro)</label>
                        <input type="text" class="form-control" id="otherTeachers" placeholder="Ex: Prof. de Ingl√™s, Prof. de M√∫sica">
                    </div>

                    <h5 class="mt-4 mb-3 text-secondary">5. Observa√ß√µes Adicionais (Recomenda√ß√µes)</h5>


                    <div class="mb-3">
                        <label for="improvements" class="form-label">√Åreas que Necessitam de Maior Aten√ß√£o e Apoio (Recomenda√ß√µes):</label>
                        <textarea class="form-control" id="improvements" placeholder="Sugest√µes de interven√ß√£o em casa e na escola."></textarea>
                    </div>

                    <div class="mb-5">
                        <label for="generalObservations" class="form-label">Observa√ß√µes Gerais (Opcional):</label>
                        <textarea class="form-control" id="generalObservations" placeholder="Coment√°rios finais ou informa√ß√µes relevantes."></textarea>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                        <button type="button" class="btn btn-warning btn-lg" id="saveReport" data-id="" title="Salva o relat√≥rio no servidor para edi√ß√£o posterior.">üíæ Salvar Relat√≥rio</button>
                        <button type="button" class="btn btn-primary btn-lg" id="generateReport" title="Gera o PDF com base nos dados do formul√°rio.">üìÑ Gerar PDF</button>
                    </div>

                </form>
            </div>

            <div class="tab-pane fade" id="saved-tab-pane" role="tabpanel" aria-labelledby="saved-tab" tabindex="0">
                <h5 class="mt-3 mb-3 text-secondary">Relat√≥rios Salvos no Servidor Firebase</h5>

                <div class="row mb-3 align-items-center">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchStudent" placeholder="Buscar por Nome do Aluno ou S√©rie">
                            <button class="btn btn-outline-secondary" type="button" id="searchButton">üîé Buscar</button>
                            <button class="btn btn-outline-secondary" type="button" id="clearSearch">‚ùå Limpar</button>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-danger btn-sm" id="clearAllReports" style="display: none;" title="Apaga TODOS os relat√≥rios salvos. Cuidado!">üö® Apagar Tudo</button>
                    </div>
                </div>

                <div id="savedReportsList">
                    </div>
                
                <p id="noReportsMessage" class="text-center text-muted mt-4" style="display: none;">Nenhum relat√≥rio salvo ainda. Use o bot√£o "Salvar Relat√≥rio" na aba anterior!</p>
            </div>

        </div> <p class="text-center mt-5 text-muted"><small>Desenvolvido por Nay como ferramenta de apoio pedag√≥gico.</small></p>

    </div> 
<script>
// ==========================================================
// 1. CONFIGURA√á√ÉO E INICIALIZA√á√ÉO DO FIREBASE
// ==========================================================

const firebaseConfig = {
    // ATEN√á√ÉO: Use suas pr√≥prias credenciais! Estas s√£o fict√≠cias.
    apiKey: "AIzaSyCchixFInasRgOlmjPEafVYwVlGSqkqMIg", 
    authDomain: "geradorrelatoriosescola.firebaseapp.com",
    projectId: "geradorrelatoriosescola",
    storageBucket: "geradorrelatoriosescola.firebasestorage.app",
    messagingSenderId: "286288216743",
    appId: "1:286288216743:web:52ac6a1f23cdb7a4c91182"
};

const app = firebase.initializeApp(firebaseConfig);
const db = app.firestore();
const auth = app.auth(); 
const storageRef = app.storage().ref(); 

// Vari√°veis Globais
let isCoordinator = false; 
let relatoriosCache = [];
const reportsCollection = db.collection("relatorios"); 
const configDocRef = db.collection("config").doc("school_details");

// Vari√°vel de Permiss√£o (Simplificada)
let usuarioPermissao = { tipo: 'deslogado' }; 


// ==========================================================
// 2. L√ìGICA DE AUTENTICA√á√ÉO E PERMISS√ÉO
// ==========================================================

auth.onAuthStateChanged(user => {
    // Usando .container aqui, mas no HTML est√° aninhado, 
    // ent√£o vou usar o elemento pai que est√° fora do aninhamento para controle.
    // Como voc√™ s√≥ tem um .container, vou selecionar ele.
    const appContent = document.querySelector('.container'); 
    
    if (user) {
        if (appContent) appContent.style.display = 'block';

        // CHECAGEM CR√çTICA DE PERFIL (Para Coordenador)
        db.collection('usuarios').doc(user.uid).get()
            .then(doc => {
                const userData = doc.data();
                usuarioPermissao = userData || { tipo: 'professor' }; // Define a permiss√£o
                
                if (userData && (userData.tipo === 'coordenador' || userData.tipo === 'admin')) {
                    isCoordinator = true;
                    
                    // 1. HABILITA EDI√á√ÉO DOS CAMPOS DA ESCOLA
                    document.getElementById('schoolName').disabled = false;
                    document.getElementById('schoolAddress').disabled = false;
                    document.getElementById('schoolPhone').disabled = false;
                    document.getElementById('schoolWebsite').disabled = false;
                    document.getElementById('logoUpload').disabled = false;
                    
                    // 2. MOSTRA BOT√ÉO DE EXCLUS√ÉO EM MASSA
                    const clearAllBtn = document.getElementById('clearAllReports');
                    if (clearAllBtn) {
                        clearAllBtn.style.display = 'inline-block';
                    }
                } else {
                    isCoordinator = false;
                    // ESCONDE BOT√ÉO DE EXCLUS√ÉO EM MASSA para professores
                    const clearAllBtn = document.getElementById('clearAllReports');
                    if (clearAllBtn) {
                        clearAllBtn.style.display = 'none';
                    }
                }
                
                // Chamada de Inicializa√ß√£o da Aplica√ß√£o
                loadAppContent(); 
            })
            .catch(error => {
                console.error("Erro ao carregar perfil do usu√°rio:", error);
                isCoordinator = false;
                loadAppContent();
            });
        
    } else {
        // Usu√°rio deslogado: redireciona
        if (appContent) appContent.style.display = 'none'; 
        window.location.href = 'login.html';
    }
});


// ==========================================================
// 3. FUN√á√ïES DE CONFIGURA√á√ÉO DA ESCOLA 
// ==========================================================

async function saveSchoolConfig(schoolName, logoBase64, schoolAddress, schoolPhone, schoolWebsite) {
    if (!auth.currentUser || !isCoordinator) return; // Apenas coordenador salva
    const config = {
        schoolName: schoolName,
        logoBase64: logoBase64 || '',
        schoolAddress: schoolAddress || '',
        schoolPhone: schoolPhone || '',
        schoolWebsite: schoolWebsite || ''
    };
    try {
        await configDocRef.set(config, { merge: true });
        console.log("Configura√ß√µes da escola salvas no Firebase.");
    } catch (e) {
        console.error("Erro ao salvar configura√ß√µes da escola no Firebase: ", e);
    }
}

async function loadSchoolConfig() {
    if (!auth.currentUser) return null; 
    try {
        const doc = await configDocRef.get();
        if (doc.exists) {
            applySavedLogo(doc.data());
            return doc.data();
        }
    } catch (e) {
        console.error("Erro ao carregar configura√ß√µes da escola do Firebase: ", e);
    }
    return null;
}

function applySavedLogo(config) {
    const logoPreview = document.getElementById('logoPreview');
    const logoPlaceholder = document.getElementById('logoPlaceholder');
    const schoolNameInput = document.getElementById('schoolName');
    const schoolAddressInput = document.getElementById('schoolAddress');
    const schoolPhoneInput = document.getElementById('schoolPhone');
    const schoolWebsiteInput = document.getElementById('schoolWebsite');

    if (config) {
        // Atualiza os campos
        if (config.schoolName) { schoolNameInput.value = config.schoolName; }
        if (config.schoolAddress) { schoolAddressInput.value = config.schoolAddress; }
        if (config.schoolPhone) { schoolPhoneInput.value = config.schoolPhone; }
        if (config.schoolWebsite) { schoolWebsiteInput.value = config.schoolWebsite; }

        if (config.logoBase64 && config.logoBase64.startsWith('data:image')) {
            logoPreview.src = config.logoBase64;
            logoPreview.style.display = 'block';
            logoPlaceholder.style.display = 'none';
            document.getElementById('logoText').textContent = 'Logo salva (Clique para remover)';
            return; 
        }
    }
    
    logoPreview.src = '';
    logoPreview.style.display = 'none';
    logoPlaceholder.style.display = 'block';
    document.getElementById('logoText').textContent = 'Logo da Escola';
}

async function updateSchoolConfigFromForm() {
    if (!auth.currentUser || !isCoordinator) return;
    const logoPreview = document.getElementById('logoPreview');
    // Usa o src da preview, que pode ser Base64 ou vazio
    const logoData = logoPreview.style.display !== 'none' && logoPreview.src.startsWith('data:image') 
                                 ? logoPreview.src 
                                 : ''; 
    await saveSchoolConfig(
        document.getElementById('schoolName').value,
        logoData,
        document.getElementById('schoolAddress').value,
        document.getElementById('schoolPhone').value,
        document.getElementById('schoolWebsite').value
    );
}

async function handleLogoUpload() {
    if (!auth.currentUser || !isCoordinator) {
        alert("Apenas coordenadores podem fazer upload/alterar a logo.");
        return;
    }

    const fileInput = document.getElementById('logoUpload');
    const file = fileInput.files[0];
    
    if (file) {
        const reader = new FileReader();
        reader.onload = async function (e) {
            const logoBase64 = e.target.result;
            const logoPreview = document.getElementById('logoPreview');
            const logoPlaceholder = document.getElementById('logoPlaceholder');
            logoPreview.src = logoBase64;
            logoPreview.style.display = 'block';
            logoPlaceholder.style.display = 'none';
            document.getElementById('logoText').textContent = 'Logo carregada e salva automaticamente';
            await updateSchoolConfigFromForm(); // Salva no Firestore
        };
        reader.readAsDataURL(file);
    } else {
        // Limpa a logo
        await saveSchoolConfig(
             document.getElementById('schoolName').value,
             '',
             document.getElementById('schoolAddress').value,
             document.getElementById('schoolPhone').value,
             document.getElementById('schoolWebsite').value
        );
        const config = await loadSchoolConfig();
        applySavedLogo(config);
    }
    fileInput.value = '';
}


// ==========================================================
// 4. FUN√á√ïES DE RELAT√ìRIO (GET, SET, SAVE, LIST)
// ==========================================================

function getReportDataFromForm() {
    const logoPreview = document.getElementById('logoPreview');
    const logoData = logoPreview.style.display !== 'none' && logoPreview.src.startsWith('data:image') 
                                 ? logoPreview.src 
                                 : ''; 

    const reportData = {
        // Info da Escola 
        schoolName: document.getElementById('schoolName').value,
        schoolAddress: document.getElementById('schoolAddress').value, 
        schoolPhone: document.getElementById('schoolPhone').value,       
        schoolWebsite: document.getElementById('schoolWebsite').value,   
        logoBase64: logoData, // Inclui a logo Base64

        // Info do Aluno/Professor/Relat√≥rio
        studentName: document.getElementById('studentName').value,
        studentAge: document.getElementById('studentAge').value,
        studentGrade: document.getElementById('studentGrade').value,
        schoolYear: document.getElementById('schoolYear').value,
        teacherName: document.getElementById('teacherName').value,
        otherTeachers: document.getElementById('otherTeachers').value,
        digitalSignatureText: document.getElementById('digitalSignatureText').value, 
        
        // Relato Descritivo Geral do Aluno
        studentDevelopment: document.getElementById('studentDevelopment').value, 
        
        // Campos de Experi√™ncia
        devEuOutroNos: document.getElementById('devEuOutroNos').value,
        devEscutaFala: document.getElementById('devEscutaFala').value,
        devEspacoTempo: document.getElementById('devEspacoTempo').value,
        devCorpoGesto: document.getElementById('devCorpoGesto').value,
        devTracosSons: document.getElementById('devTracosSons').value,
        
        // Observa√ß√µes Adicionais
        improvements: document.getElementById('improvements').value,
        generalObservations: document.getElementById('generalObservations').value,
    };

    return reportData;
}
    
function validateForm() {
    const requiredFields = [
          'studentName', 'studentAge', 
          'studentGrade', 'schoolYear', 'teacherName', 'schoolName',
          'studentDevelopment' 
    ];
    
    let isValid = true;
    for (let fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        field.classList.remove('is-invalid');
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } 
    }
    
    if (!isValid) {
        alert('Por favor, preencha todos os campos obrigat√≥rios marcados com *!');
    }
    
    return isValid;
}

async function getAndCacheReports() {
    if (!auth.currentUser) return;

    let query = reportsCollection;
    
    // VERIFICA SE √â COORDENADOR/ADMIN PARA EXECUTAR A CONSULTA COMPLETA
    if (isCoordinator) {
        // Coordenador: V√™ todos
        query = query.orderBy('studentName', 'asc');
    } else {
        // Professor: V√™ apenas os dele.
        query = query
            .where('professor_id', '==', auth.currentUser.uid)
            .orderBy('data_atualizacao', 'desc');
    }
    
    try {
        const snapshot = await query.get();
        relatoriosCache = []; 
        snapshot.forEach(doc => {
            relatoriosCache.push({ id: doc.id, ...doc.data() });
        });
        console.log(`Relat√≥rios carregados para o cache: ${relatoriosCache.length}`);
        
        updateSavedReportsDisplay(relatoriosCache);
        
    } catch (e) {
        console.error("Erro ao carregar relat√≥rios do Firestore. Poss√≠vel falta de √çndice Composto: ", e);
        document.getElementById('savedReportsCount').textContent = 'ERRO';
        document.getElementById('noReportsMessage').textContent = 'Erro ao carregar relat√≥rios. Verifique o console do navegador e os √≠ndices/regras do Firebase.';
        document.getElementById('noReportsMessage').style.display = 'block';
    }
}

async function saveReportToFirebase() {
    if (!auth.currentUser || !validateForm()) {
        return;
    }

    const reportData = getReportDataFromForm();
    
    // Metadados do Firebase
    reportData.professor_id = auth.currentUser.uid; 
    reportData.data_atualizacao = firebase.firestore.FieldValue.serverTimestamp(); 
    reportData.timestamp = new Date().toLocaleString('pt-BR'); 

    // Padroniza a turma
    reportData.studentGrade = reportData.studentGrade.toUpperCase().trim(); 

    let docId = document.getElementById('saveReport').dataset.id;

    try {
        if (docId && docId !== 'NEW_REPORT_ID' && docId.length > 10) {
            // Edi√ß√£o
            await reportsCollection.doc(docId).set(reportData, { merge: true });
            alert(`Relat√≥rio do(a) aluno(a) ${reportData.studentName} atualizado com sucesso no servidor!`);
        } else {
            // Cria√ß√£o
            const docRef = await reportsCollection.add(reportData);
            docId = docRef.id;
            document.getElementById('saveReport').dataset.id = docId;
            alert(`Relat√≥rio do(a) aluno(a) ${reportData.studentName} salvo com sucesso no servidor!`);
        }
        
        await getAndCacheReports();
        
        return docId;

    } catch (e) {
        console.error("Erro ao salvar relat√≥rio no Firebase: ", e);
        alert("Erro ao salvar relat√≥rio. Verifique sua conex√£o e permiss√µes do Firebase/Firestore.");
    }
}

async function fillFormWithReport(report) {
    document.getElementById('saveReport').dataset.id = report.id; 
    
    const currentConfig = await loadSchoolConfig();
    document.getElementById('schoolName').value = report.schoolName || currentConfig?.schoolName || '';
    document.getElementById('schoolAddress').value = report.schoolAddress || currentConfig?.schoolAddress || '';
    document.getElementById('schoolPhone').value = report.schoolPhone || currentConfig?.schoolPhone || '';
    document.getElementById('schoolWebsite').value = report.schoolWebsite || currentConfig?.schoolWebsite || '';
    
    document.getElementById('studentName').value = report.studentName || '';
    document.getElementById('studentAge').value = report.studentAge || '';
    document.getElementById('studentGrade').value = report.studentGrade || '';
    document.getElementById('schoolYear').value = report.schoolYear || '';
    document.getElementById('teacherName').value = report.teacherName || '';
    document.getElementById('otherTeachers').value = report.otherTeachers || '';
    document.getElementById('digitalSignatureText').value = report.digitalSignatureText || ''; 
    
    // Carrega a descri√ß√£o geral
    document.getElementById('studentDevelopment').value = report.studentDevelopment || '';
    
    document.getElementById('improvements').value = report.improvements || '';
    document.getElementById('generalObservations').value = report.generalObservations || '';
    
    document.getElementById('devEuOutroNos').value = report.devEuOutroNos || '';
    document.getElementById('devEscutaFala').value = report.devEscutaFala || '';
    document.getElementById('devEspacoTempo').value = report.devEspacoTempo || '';
    document.getElementById('devCorpoGesto').value = report.devCorpoGesto || '';
    document.getElementById('devTracosSons').value = report.devTracosSons || '';
    
    if(report.logoBase64 && report.logoBase64.startsWith('data:image')) {
        applySavedLogo({ logoBase64: report.logoBase64 });
    } else {
        applySavedLogo(currentConfig);
    }

    // CORRE√á√ÉO: Troca de aba for√ßada para 'Criar Relat√≥rio'
    const targetTab = document.getElementById('create-tab');
    const targetPane = document.getElementById('create-tab-pane');
    const currentTab = document.getElementById('saved-tab');
    const currentPane = document.getElementById('saved-tab-pane');

    if (currentTab) currentTab.classList.remove('active');
    if (currentPane) currentPane.classList.remove('active', 'show');

    if (targetTab) targetTab.classList.add('active');
    if (targetPane) targetPane.classList.add('active', 'show');
    
    alert(`Relat√≥rio do(a) aluno(a) ${report.studentName} carregado para edi√ß√£o. Lembre-se de clicar em "Salvar Relat√≥rio" para manter as altera√ß√µes.`);
}

async function deleteReport(id) {
    if (!auth.currentUser) return;
    
    const reportToDelete = relatoriosCache.find(r => r.id === id);
    if (!reportToDelete) {
        alert("Relat√≥rio n√£o encontrado.");
        return;
    }

    const isOwner = reportToDelete.professor_id === auth.currentUser.uid;
    
    if (!isCoordinator && !isOwner) {
         alert("Permiss√£o negada. Apenas o(a) professor(a) criador(a) ou a Coordenadoria podem excluir este relat√≥rio.");
         return;
    }
    
    if (confirm('Tem certeza que deseja EXCLUIR este relat√≥rio? Esta a√ß√£o √© irrevers√≠vel!')) {
        try {
            await reportsCollection.doc(id).delete();
            alert('Relat√≥rio exclu√≠do do Firebase com sucesso!');
            
            await getAndCacheReports();
            
            if (document.getElementById('saveReport').dataset.id === id) {
                 clearForm();
            }
            
        } catch (e) {
            console.error("Erro ao excluir relat√≥rio no Firebase: ", e);
            alert("Erro ao excluir relat√≥rio.");
        }
    }
}

async function clearAllReports() {
    if (!auth.currentUser || !isCoordinator) {
        alert("Permiss√£o negada. Apenas a Coordenadoria pode apagar todos os relat√≥rios.");
        return;
    }
    
    if (confirm("ATEN√á√ÉO! Voc√™ tem certeza que deseja APAGAR TODOS OS RELAT√ìRIOS SALVOS? Esta a√ß√£o √© IRREVERS√çVEL e afetar√° todos os professores.")) {
        try {
            const batch = db.batch();
            relatoriosCache.forEach(report => {
                const docRef = reportsCollection.doc(report.id);
                batch.delete(docRef);
            });
            await batch.commit();
            alert("Todos os relat√≥rios foram exclu√≠dos com sucesso!");
            await getAndCacheReports(); 
            clearForm();
        } catch (e) {
            console.error("Erro ao apagar todos os relat√≥rios:", e);
            alert("Erro ao apagar relat√≥rios. Consulte o console.");
        }
    }
}


function clearForm() {
    document.getElementById('reportForm').reset();
    document.getElementById('saveReport').dataset.id = '';
    
    // Recarrega config da escola para n√£o sumir o logo
    loadSchoolConfig(); 
}

function updateSavedReportsDisplay(reports) {
    const listElement = document.getElementById('savedReportsList');
    const countElement = document.getElementById('savedReportsCount');
    const messageElement = document.getElementById('noReportsMessage');
    
    listElement.innerHTML = '';
    countElement.textContent = reports.length;

    if (reports.length === 0) {
        messageElement.style.display = 'block';
        return;
    }
    messageElement.style.display = 'none';

    reports.forEach(report => {
        const item = document.createElement('div');
        item.className = 'report-item';
        
        const info = document.createElement('span');
        info.innerHTML = `<strong>${report.studentName}</strong> (${report.studentGrade}) - <small class="text-muted">${report.teacherName} (Salvo: ${report.timestamp || 'N/A'})</small>`;
        
        const actions = document.createElement('div');
        
        const loadBtn = document.createElement('button');
        loadBtn.className = 'btn btn-sm btn-info me-2';
        loadBtn.innerHTML = '‚úèÔ∏è Carregar';
        loadBtn.onclick = () => fillFormWithReport(report);
        
        const pdfBtn = document.createElement('button');
        pdfBtn.className = 'btn btn-sm btn-primary me-2';
        pdfBtn.innerHTML = 'üìÑ PDF';
        pdfBtn.onclick = () => generateReport(report.id);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-sm btn-danger';
        deleteBtn.innerHTML = 'üóëÔ∏è Excluir';
        deleteBtn.onclick = () => deleteReport(report.id);

        actions.appendChild(loadBtn);
        actions.appendChild(pdfBtn);
        actions.appendChild(deleteBtn);
        
        item.appendChild(info);
        item.appendChild(actions);
        listElement.appendChild(item);
    });
}

function filterReports() {
    const searchTerm = document.getElementById('searchStudent').value.toLowerCase();
    
    if (searchTerm.trim() === '') {
        updateSavedReportsDisplay(relatoriosCache);
        return;
    }

    const filtered = relatoriosCache.filter(report => {
        const nameMatch = report.studentName && report.studentName.toLowerCase().includes(searchTerm);
        const gradeMatch = report.studentGrade && report.studentGrade.toLowerCase().includes(searchTerm);
        const teacherMatch = report.teacherName && report.teacherName.toLowerCase().includes(searchTerm);
        return nameMatch || gradeMatch || teacherMatch;
    });

    updateSavedReportsDisplay(filtered);
}

// ==========================================================
// 5. FUN√á√ÉO DE GERA√á√ÉO DE PDF
// ==========================================================

async function generateReport(reportId = null) {
    let data;
    if (reportId) {
        // Carrega dados do cache/firebase se for a partir da lista
        const savedReport = relatoriosCache.find(r => r.id === reportId);
        if (!savedReport) {
            alert('Relat√≥rio n√£o encontrado no cache. Tente carregar para o formul√°rio e gerar o PDF novamente.');
            return;
        }
        data = savedReport;
    } else {
        // Pega dados diretamente do formul√°rio
        if (!validateForm()) return;
        data = getReportDataFromForm();
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4'); 
    
    // Dimens√µes
    const PAGE_WIDTH = doc.internal.pageSize.getWidth();
    const PAGE_HEIGHT = doc.internal.pageSize.getHeight();
    const MARGIN_X = 15;
    const MARGIN_BOTTOM = 20; // Margem de seguran√ßa no final
    const MAX_WIDTH = PAGE_WIDTH - 2 * MARGIN_X;
    const TEXT_LINE_HEIGHT_MM = 5.5; // Altura da linha para textos longos (otimizado)
    let currentY = 15; 
    
    // --- FUN√á√ÉO AUXILIAR PARA VERIFICAR QUEBRA DE P√ÅGINA ---
    const checkPageBreak = (requiredSpace) => {
        if (currentY + requiredSpace > PAGE_HEIGHT - MARGIN_BOTTOM) {
            doc.addPage();
            currentY = 15; // Inicia na margem superior da nova p√°gina
        }
    };
    
    // --- FUN√á√ÉO AUXILIAR PARA ADICIONAR T√çTULOS E SUBT√çTULOS ---
    const addTitle = (text, size, style = 'bold', spaceAfter = true) => {
        checkPageBreak(5); // Sempre verifica antes de um t√≠tulo
        doc.setFontSize(size);
        doc.setFont('helvetica', style);
        doc.text(text, MARGIN_X, currentY);
        currentY += (size / 2) + (spaceAfter ? 2 : 0); // Espa√ßamento proporcional
    }

    // --- FUN√á√ÉO AUXILIAR PARA ADICIONAR TEXTO COM QUEBRA DE LINHA ---
    const addLongText = (text, size, style = 'normal', line_height = TEXT_LINE_HEIGHT_MM) => {
        if (!text || text.trim() === '') return;
        doc.setFontSize(size);
        doc.setFont('helvetica', style);
        
        const lines = doc.splitTextToSize(text, MAX_WIDTH);
        const requiredHeight = lines.length * line_height;

        checkPageBreak(requiredHeight + 3); // Verifica com a altura do texto + margem de 3mm
        
        doc.text(lines, MARGIN_X, currentY);
        currentY += requiredHeight; 
    };
    
    // --- 1. CABE√áALHO DA ESCOLA (Logo e Informa√ß√µes) - TUDO CENTRALIZADO ---
    
    if (data.logoBase64 && data.logoBase64.startsWith('data:image')) {
        const logoSize = 30; // 30mm width
        // Calcula a posi√ß√£o X para centralizar a logo
        const logoX_centered = (PAGE_WIDTH / 2) - (logoSize / 2); 
        doc.addImage(data.logoBase64, 'PNG', logoX_centered, 15, logoSize, logoSize); 
        
        currentY = 50; // Nova posi√ß√£o Y, abaixo da logo (15 + 30 + 5 de espa√ßo)
    } else {
        currentY = 15;
    }
    
    // Fun√ß√£o para centralizar o texto
    const centerText = (text, y, size, style = 'normal') => {
        doc.setFontSize(size);
        doc.setFont('helvetica', style);
        let textWidth = doc.getStringUnitWidth(text) * doc.getFontSize() / doc.internal.scaleFactor;
        let centerX = (PAGE_WIDTH - textWidth) / 2;
        doc.text(text, centerX, y); 
    };

    // Linha 1: Nome da Escola
    centerText(data.schoolName.toUpperCase(), currentY, 16, 'bold');
    currentY += 5; 

    // Linha 2: Endere√ßo
    centerText(data.schoolAddress, currentY, 10, 'normal');
    currentY += 5; 

    // Linha 3: Contato
    centerText(`Tel: ${data.schoolPhone} | Web: ${data.schoolWebsite}`, currentY, 10, 'normal'); 
    currentY += 5;

    // Linha divis√≥ria
    doc.line(MARGIN_X, currentY, PAGE_WIDTH - MARGIN_X, currentY); 
    currentY += 5; // Espa√ßo ap√≥s a linha

    // --- 2. T√çTULO E DADOS DO ALUNO (ALINHAMENTO CORRIGIDO) ---
    
    addTitle('RELAT√ìRIO INDIVIDUAL DE AVALIA√á√ÉO DESCRITIVA', 14, 'bold');
    currentY += 2;
    
    // Defini√ß√£o das coordenadas X
    const LEFT_LABEL_X = MARGIN_X;
    const LEFT_VALUE_X = MARGIN_X + 25;
    const RIGHT_LABEL_X = 150; 
    const RIGHT_VALUE_X = 175; 

    // LINHA 1: ALUNO(A) e IDADE
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text('ALUNO(A):', LEFT_LABEL_X, currentY);
    doc.setFont('helvetica', 'normal');
    doc.text(data.studentName, LEFT_VALUE_X, currentY); 
    
    doc.setFont('helvetica', 'bold');
    doc.text('IDADE:', RIGHT_LABEL_X, currentY); 
    doc.setFont('helvetica', 'normal');
    doc.text(data.studentAge, RIGHT_VALUE_X, currentY); 
    currentY += 5;

    // LINHA 2: S√âRIE/TURMA e PER√çODO
    doc.setFont('helvetica', 'bold');
    doc.text('S√âRIE/TURMA:', LEFT_LABEL_X, currentY);
    doc.setFont('helvetica', 'normal');
    doc.text(data.studentGrade, LEFT_VALUE_X, currentY);

    doc.setFont('helvetica', 'bold');
    doc.text('PER√çODO:', RIGHT_LABEL_X, currentY); 
    doc.setFont('helvetica', 'normal');
    doc.text(data.schoolYear, RIGHT_VALUE_X, currentY); 
    currentY += 8; // Espa√ßo entre as informa√ß√µes e a pr√≥xima se√ß√£o

    // --- SE√á√ÉO 3: NOVO CAMPO - DESENVOLVIMENTO GERAL ---
    
    addTitle('3. Relato Descritivo Geral do Aluno', 12, 'bold');
    addLongText(data.studentDevelopment, 10, 'normal'); 
    currentY += 5; // Espa√ßo ap√≥s o texto

    // --- SE√á√ÉO 4: CAMPOS DE EXPERI√äNCIA (BNCC) ---
    
    addTitle('4. Detalhamento por Campos de Experi√™ncia (BNCC)', 12, 'bold');
    
    // O Eu, O Outro e o N√≥s
    addTitle('O Eu, O Outro e o N√≥s:', 10, 'bold', false); // Sem espa√ßo extra
    addLongText(data.devEuOutroNos, 10, 'normal'); 
    currentY += 3;
    
    // Escuta, Fala, Pensamento e Imagina√ß√£o
    addTitle('Escuta, Fala, Pensamento e Imagina√ß√£o:', 10, 'bold', false); 
    addLongText(data.devEscutaFala, 10, 'normal'); 
    currentY += 3;

    // Espa√ßo, Tempo, Quantidade, Rela√ß√µes e Transforma√ß√µes
    addTitle('Espa√ßo, Tempo, Quantidade, Rela√ß√µes e Transforma√ß√µes:', 10, 'bold', false);
    addLongText(data.devEspacoTempo, 10, 'normal'); 
    currentY += 3;

    // Corpo, Gesto e Movimento
    addTitle('Corpo, Gesto e Movimento:', 10, 'bold', false);
    addLongText(data.devCorpoGesto, 10, 'normal'); 
    currentY += 3;

    // Tra√ßos, Sons, Cores e Formas
    addTitle('Tra√ßos, Sons, Cores e Formas:', 10, 'bold', false);
    addLongText(data.devTracosSons, 10, 'normal'); 
    currentY += 8;

    // --- SE√á√ÉO 5: OBSERVA√á√ïES E RECOMENDA√á√ïES ---
    
    addTitle('5. Observa√ß√µes e Recomenda√ß√µes Finais', 12, 'bold');

    // √Årea que Necessita de Maior Aten√ß√£o
    addTitle('√Åreas que Necessitam de Maior Aten√ß√£o e Apoio (Recomenda√ß√µes):', 10, 'bold', false);
    addLongText(data.improvements, 10, 'normal'); 
    currentY += 3;

    // Observa√ß√µes Gerais
    addTitle('Observa√ß√µes Gerais:', 10, 'bold', false);
    addLongText(data.generalObservations, 10, 'normal'); 
    currentY += 10;

    // --- 6. ASSINATURA - CENTRALIZADA E SEM LINHA ---
    
    // Verifica se h√° espa√ßo suficiente para a assinatura (15mm)
    checkPageBreak(15); 
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    
    // 1. Centraliza o Nome do Professor
    centerText(data.teacherName, currentY + 3, 10, 'normal');
    currentY += 7; 

    // 2. Centraliza a Assinatura Digital/T√≠tulo
    centerText(`Prof.: ${data.digitalSignatureText || 'Assinatura Digital'}`, currentY, 10, 'normal');
    currentY += 7;

    // 3. Centraliza o Local e Data
    centerText(`Local e Data: ${data.schoolAddress}, ${new Date().toLocaleDateString('pt-BR')}`, currentY, 10, 'normal');
    
    currentY += 5; 
    
    // Salvar o PDF
    doc.save(`Relat√≥rio - ${data.studentName.split(' ')[0]} - ${data.studentGrade}.pdf`);
}

// ==========================================================
// 6. ADI√á√ÉO DE LISTENERS
// ==========================================================
document.addEventListener('DOMContentLoaded', () => {
    // Escuta mudan√ßas nos campos de configura√ß√£o da escola para salvar (se for coordenador)
    ['schoolName', 'schoolAddress', 'schoolPhone', 'schoolWebsite'].forEach(id => {
        document.getElementById(id).addEventListener('change', updateSchoolConfigFromForm);
    });
    
    document.getElementById('logoUpload').addEventListener('change', handleLogoUpload);
    document.getElementById('logoPreview').addEventListener('click', handleLogoUpload); // Limpar logo ao clicar na preview
    
    document.getElementById('generateReport').addEventListener('click', () => generateReport());
    document.getElementById('saveReport').addEventListener('click', saveReportToFirebase);
    document.getElementById('clearAllReports').addEventListener('click', clearAllReports);
    document.getElementById('searchButton').addEventListener('click', filterReports);
    document.getElementById('clearSearch').addEventListener('click', () => {
        document.getElementById('searchStudent').value = '';
        filterReports();
    });
    document.getElementById('logoutButton').addEventListener('click', () => {
        auth.signOut().then(() => {
            window.location.href = 'login.html';
        }).catch((error) => {
            console.error("Erro ao fazer logout:", error);
            alert("Erro ao tentar sair.");
        });
    });
    
    // --- CORRE√á√ÉO DE NAVEGA√á√ÉO ENTRE ABAS ---

    const createTab = document.getElementById('create-tab');
    if (createTab) {
        createTab.addEventListener('click', (e) => {
            // IMPEDE O COMPORTAMENTO PADR√ÉO DO LINK DE ABA (ESSENCIAL)
            e.preventDefault(); 
            
            // IDs das abas e pain√©is
            const targetTab = document.getElementById('create-tab');
            const targetPane = document.getElementById('create-tab-pane');
            const currentTab = document.getElementById('saved-tab');
            const currentPane = document.getElementById('saved-tab-pane');

            // 1. Desativa a aba atual ('Relat√≥rios Salvos')
            if (currentTab) currentTab.classList.remove('active');
            if (currentPane) currentPane.classList.remove('active', 'show');

            // 2. Ativa a aba de destino ('Criar Relat√≥rio')
            if (targetTab) targetTab.classList.add('active');
            if (targetPane) targetPane.classList.add('active', 'show');
            
            // Limpa o formul√°rio para um novo relat√≥rio (e recarrega a config da escola)
            clearForm(); 
        });
    }

    const savedTab = document.getElementById('saved-tab');
    if (savedTab) {
        savedTab.addEventListener('click', (e) => {
            // IMPEDE O COMPORTAMENTO PADR√ÉO DO LINK DE ABA (ESSENCIAL)
            e.preventDefault(); 
            
            // IDs das abas e pain√©is (assumindo a estrutura padr√£o do Bootstrap)
            const targetTab = document.getElementById('saved-tab');
            const targetPane = document.getElementById('saved-tab-pane');
            const currentTab = document.getElementById('create-tab');
            const currentPane = document.getElementById('create-tab-pane');

            // 1. Desativa a aba atual ('Criar Relat√≥rio')
            if (currentTab) currentTab.classList.remove('active');
            if (currentPane) currentPane.classList.remove('active', 'show');

            // 2. Ativa a aba de destino ('Relat√≥rios Salvos')
            if (targetTab) targetTab.classList.add('active');
            if (targetPane) targetPane.classList.add('active', 'show');

            // 3. Garante que os relat√≥rios sejam carregados/exibidos
            getAndCacheReports();
        });
    }
    
    // Seta o ID do save ao carregar (se vazio, √© novo)
    document.getElementById('saveReport').dataset.id = '';
});

// Inicializa a aplica√ß√£o (Chamado em onAuthStateChanged)
function loadAppContent() {
    loadSchoolConfig();
    getAndCacheReports(); // Inicializa o cache dos relat√≥rios na primeira carga
}


</script>
</body>
</html>
