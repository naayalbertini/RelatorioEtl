<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Relat√≥rio Individual de Avalia√ß√£o Descritiva (Educa√ß√£o Infantil/Ensino Fundamental I)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 900px;
            margin-top: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        /* OTIMIZA√á√ÉO MOBILE: Remove sombra e arredondamento nas bordas em telas pequenas para se parecer com um app */
        @media (max-width: 767px) {
            .container {
                padding: 15px; 
                box-shadow: none; 
                margin-top: 0;
                margin-bottom: 0;
                border-radius: 0;
            }
            .row > div[class*="col-"] {
                margin-bottom: 15px; 
            }
            /* Ajusta a fonte do t√≠tulo em mobile */
            .text-start h2 {
                font-size: 1.5rem !important;
            }
        }

        .nav-tabs .nav-link {
            font-weight: bold;
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            border-color: #dee2e6 #dee2e6 #fff;
            background-color: #fff;
        }
        .form-label.required::after {
            content: " *";
            color: red;
            font-weight: bold;
        }
        textarea {
            min-height: 120px;
            font-family: Arial, sans-serif;
        }
        /* Estilo para a pr√©-visualiza√ß√£o da logo */
        .logo-upload-box {
            border: 1px dashed #ccc;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        .logo-preview {
            max-width: 100%;
            max-height: 80px;
            display: none; 
            margin-bottom: 5px;
        }
        .logo-placeholder {
            font-size: 30px;
            color: #6c757d;
        }
        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .report-item:last-child {
            border-bottom: none;
        }
        #savedReportsList {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="container"> 
        <div class="d-flex flex-column flex-md-row justify-content-md-between align-items-start align-items-md-center mb-4 pb-2 border-bottom">
            
            <div class="text-start mb-3 mb-md-0">
                <h2 class="text-primary" style="margin-bottom: 0;">Gerador de Relat√≥rio Individual</h2>
                <p class="text-muted" style="font-size: 0.9em; margin-bottom: 0;">Ferramenta para Educa√ß√£o Infantil e Ensino Fundamental I</p>
            </div>
            
            <button id="logoutButton" class="btn btn-danger btn-sm align-self-end align-self-md-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-right me-1" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1-.5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 1 3.5v9A1.5 1.5 0 0 0 2.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                    <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                </svg>
                Sair
            </button>
            
        </div>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-tab-pane" type="button" role="tab" aria-controls="create-tab-pane" aria-selected="true">‚úçÔ∏è Criar Relat√≥rio</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="saved-tab" data-bs-toggle="tab" data-bs-target="#saved-tab-pane" type="button" role="tab" aria-controls="saved-tab-pane" aria-selected="false">üìö Relat√≥rios Salvos (<span id="savedReportsCount">0</span>)</button>
            </li>
        </ul>

        <div class="tab-content pt-3" id="myTabContent">

            <div class="tab-pane fade show active" id="create-tab-pane" role="tabpanel" aria-labelledby="create-tab" tabindex="0">
                <form id="reportForm">
                    
                    <h5 class="mt-3 mb-3 text-secondary">1. Configura√ß√£o da Escola (Salva Automaticamente)</h5>
                    <div class="row mb-3">
                        <div class="col-12 col-md-4 order-md-1 mb-3 mb-md-0">
                            <input type="text" class="form-control" id="schoolName" placeholder="Escola Tra√ßos e Letras" required disabled aria-label="Nome da Escola" title="Campo edit√°vel apenas por Coordenadores/Admin">
                        </div>
                        <div class="col-12 col-md-4 order-md-2 mb-3 mb-md-0">
                            <input type="text" class="form-control" id="schoolAddress" placeholder="Catu/Ba" required disabled aria-label="Endere√ßo da Escola" title="Campo edit√°vel apenas por Coordenadores/Admin">
                        </div>
                        <div class="col-12 col-md-4 order-md-3">
                            <div class="logo-upload-box" onclick="document.getElementById('logoUpload').click()">
                                <input type="file" id="logoUpload" accept="image/*" style="display: none;">
                                <img id="logoPreview" class="logo-preview" alt="Pr√©-visualiza√ß√£o da Logo">
                                <span id="logoPlaceholder" class="logo-placeholder">üñºÔ∏è</span>
                                <small class="text-muted" id="logoText">Logo da Escola</small>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-12 col-md-6 mb-3 mb-md-0">
                            <input type="text" class="form-control" id="schoolPhone" placeholder=" (71) 98200-2432" required disabled aria-label="Telefone da Escola" title="Campo edit√°vel apenas por Coordenadores/Admin">
                        </div>
                        <div class="col-12 col-md-6">
                            <input type="text" class="form-control" id="schoolWebsite" placeholder="www.portaltracoseletras.com.br" required disabled aria-label="Site da Escola" title="Campo edit√°vel apenas por Coordenadores/Admin">
                        </div>
                    </div>

                    <h5 class="mt-3 mb-3 text-secondary">2. Informa√ß√µes do Aluno/Professor</h5>
                    <div class="row mb-3">
                        <div class="col-12 col-md-6 mb-3 mb-md-0">
                            <label for="studentName" class="form-label required">Nome Completo do Aluno(a)</label>
                            <input type="text" class="form-control" id="studentName" required>
                        </div>
                        <div class="col-6 col-md-3">
                            <label for="studentAge" class="form-label required">Idade/Anos</label>
                            <input type="text" class="form-control" id="studentAge" required placeholder="Ex: 4 anos">
                        </div>
                        <div class="col-6 col-md-3">
                            <label for="studentGrade" class="form-label required">S√©rie/Turma</label>
                            <input type="text" class="form-control" id="studentGrade" required placeholder="Ex: Infantil III">
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-12 col-md-4 mb-3 mb-md-0">
                            <label for="schoolYear" class="form-label required">Ano Letivo/Semestre</label>
                            <input type="text" class="form-control" id="schoolYear" required placeholder="Ex: 2024 / I Semestre">
                        </div>
                        <div class="col-12 col-md-4 mb-3 mb-md-0">
                            <label for="teacherName" class="form-label required">Nome do Professor(a)</label>
                            <input type="text" class="form-control" id="teacherName" required>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="digitalSignatureText" class="form-label">Texto da Assinatura Digital (Ex: Matr√≠cula, A. Profissional)</label>
                            <input type="text" class="form-control" id="digitalSignatureText" placeholder="Ex: Matr√≠cula 12345/BA">
                        </div>
                    </div>

                    <h5 class="mt-4 mb-3 text-secondary">3. Desenvolvimento: Campos de Experi√™ncia (BNCC)</h5>
                    <p class="text-muted"><small>Descreva o desenvolvimento da crian√ßa em cada campo de forma detalhada e positiva.</small></p>

                    <div class="mb-3">
                        <label for="devEuOutroNos" class="form-label">O Eu, O Outro e o N√≥s:</label>
                        <textarea class="form-control" id="devEuOutroNos" placeholder="Intera√ß√£o com pares, respeito √†s regras, autonomia, identidade."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="devEscutaFala" class="form-label">Escuta, Fala, Pensamento e Imagina√ß√£o:</label>
                        <textarea class="form-control" id="devEscutaFala" placeholder="Express√£o oral, compreens√£o de hist√≥rias, vocabul√°rio, formula√ß√£o de perguntas."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="devEspacoTempo" class="form-label">Espa√ßo, Tempo, Quantidade, Rela√ß√µes e Transforma√ß√µes:</label>
                        <textarea class="form-control" id="devEspacoTempo" placeholder="No√ß√µes espaciais e temporais, contagem, compara√ß√£o de objetos, racioc√≠nio l√≥gico-matem√°tico."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="devCorpoGesto" class="form-label">Corpo, Gesto e Movimento:</label>
                        <textarea class="form-control" id="devCorpoGesto" placeholder="Coordena√ß√£o motora ampla e fina, equil√≠brio, lateralidade, uso do corpo para expressar emo√ß√µes."></textarea>
                    </div>

                    <div class="mb-4">
                        <label for="devTracosSons" class="form-label">Tra√ßos, Sons, Cores e Formas:</label>
                        <textarea class="form-control" id="devTracosSons" placeholder="Interesse por artes visuais, m√∫sica, formas geom√©tricas, percep√ß√£o sensorial."></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label for="otherTeachers" class="form-label">Outros Professores Envolvidos (Opcional, n√£o aparece no PDF, apenas para registro)</label>
                        <input type="text" class="form-control" id="otherTeachers" placeholder="Ex: Prof. de Ingl√™s, Prof. de M√∫sica">
                    </div>

                    <h5 class="mt-4 mb-3 text-secondary">4. Observa√ß√µes Adicionais (Recomenda√ß√µes)</h5>


                    <div class="mb-3">
                        <label for="improvements" class="form-label">√Åreas que Necessitam de Maior Aten√ß√£o e Apoio (Recomenda√ß√µes):</label>
                        <textarea class="form-control" id="improvements" placeholder="Sugest√µes de interven√ß√£o em casa e na escola."></textarea>
                    </div>

                    <div class="mb-5">
                        <label for="generalObservations" class="form-label">Observa√ß√µes Gerais (Opcional):</label>
                        <textarea class="form-control" id="generalObservations" placeholder="Coment√°rios finais ou informa√ß√µes relevantes."></textarea>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                        <button type="button" class="btn btn-warning btn-lg" id="saveReport" data-id="" title="Salva o relat√≥rio no servidor para edi√ß√£o posterior.">üíæ Salvar Relat√≥rio</button>
                        <button type="button" class="btn btn-primary btn-lg" id="generateReport" title="Gera o PDF com base nos dados do formul√°rio.">üìÑ Gerar PDF</button>
                    </div>

                </form>
            </div>

            <div class="tab-pane fade" id="saved-tab-pane" role="tabpanel" aria-labelledby="saved-tab" tabindex="0">
                <h5 class="mt-3 mb-3 text-secondary">Relat√≥rios Salvos no Servidor Firebase</h5>

                <div class="row mb-3 align-items-center">
                    <div class="col-12 col-md-8 mb-3 mb-md-0">
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchStudent" placeholder="Buscar por Nome do Aluno ou S√©rie">
                            <button class="btn btn-outline-secondary" type="button" id="searchButton" title="Buscar">üîé</button>
                            <button class="btn btn-outline-secondary" type="button" id="clearSearch" title="Limpar Busca">‚ùå</button>
                        </div>
                    </div>
                    <div class="col-12 col-md-4 text-center text-md-end">
                        <button class="btn btn-danger btn-sm" id="clearAllReports" style="display: none;" title="Apaga TODOS os relat√≥rios salvos. Cuidado!">üö® Apagar Tudo</button>
                    </div>
                </div>

                <div id="savedReportsList">
                    </div>
                
                <p id="noReportsMessage" class="text-center text-muted mt-4" style="display: none;">Nenhum relat√≥rio salvo ainda. Use o bot√£o "Salvar Relat√≥rio" na aba anterior!</p>
            </div>

        </div> 
        <p class="text-center mt-5 text-muted"><small>Desenvolvido por Nay como recurso de apoio pedag√≥gico.
        </small></p>

    </div> 
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ==========================================================
// 1. CONFIGURA√á√ÉO E INICIALIZA√á√ÉO DO FIREBASE
// ==========================================================

const firebaseConfig = {
    apiKey: "AIzaSyCchixFInasRgOlmjPEafVYwVlGSqkqMIg", 
    authDomain: "geradorrelatoriosescola.firebaseapp.com",
    projectId: "geradorrelatoriosescola",
    storageBucket: "geradorrelatoriosescola.firebasestorage.app",
    messagingSenderId: "286288216743",
    appId: "1:286288216743:web:52ac6a1f23cdb7a4c91182"
};

const app = firebase.initializeApp(firebaseConfig);
const db = app.firestore();
const auth = app.auth(); 
const storageRef = app.storage().ref(); 

// Vari√°veis Globais
let isCoordinator = false; 
let relatoriosCache = [];
const reportsCollection = db.collection("relatorios"); 
const configDocRef = db.collection("config").doc("school_details");

// Vari√°vel de Permiss√£o (Simplificada)
let usuarioPermissao = { tipo: 'deslogado' }; 


// ==========================================================
// 2. L√ìGICA DE AUTENTICA√á√ÉO E PERMISS√ÉO
// ==========================================================

auth.onAuthStateChanged(user => {
    const appContent = document.querySelector('.container'); 
    
    if (user) {
        appContent.style.display = 'block';

        // CHECAGEM CR√çTICA DE PERFIL (Para Coordenador)
        db.collection('usuarios').doc(user.uid).get()
            .then(doc => {
                const userData = doc.data();
                usuarioPermissao = userData || { tipo: 'professor' }; // Define a permiss√£o
                
                if (userData && (userData.tipo === 'coordenador' || userData.tipo === 'admin')) {
                    isCoordinator = true;
                    
                    // 1. HABILITA EDI√á√ÉO DOS CAMPOS DA ESCOLA
                    document.getElementById('schoolName').disabled = false;
                    document.getElementById('schoolAddress').disabled = false;
                    document.getElementById('schoolPhone').disabled = false;
                    document.getElementById('schoolWebsite').disabled = false;
                    document.getElementById('logoUpload').disabled = false;
                    
                    // 2. MOSTRA BOT√ÉO DE EXCLUS√ÉO EM MASSA
                    const clearAllBtn = document.getElementById('clearAllReports');
                    if (clearAllBtn) {
                        clearAllBtn.style.display = 'inline-block';
                    }
                } else {
                    isCoordinator = false;
                    // ESCONDE BOT√ÉO DE EXCLUS√ÉO EM MASSA para professores
                    const clearAllBtn = document.getElementById('clearAllReports');
                    if (clearAllBtn) {
                        clearAllBtn.style.display = 'none';
                    }
                }
                
                // Chamada de Inicializa√ß√£o da Aplica√ß√£o
                loadAppContent(); 
            })
            .catch(error => {
                console.error("Erro ao carregar perfil do usu√°rio:", error);
                isCoordinator = false;
                loadAppContent();
            });
        
    } else {
        // Usu√°rio deslogado: redireciona
        appContent.style.display = 'none'; 
        window.location.href = 'login.html';
    }
});


// ==========================================================
// 3. FUN√á√ïES DE CONFIGURA√á√ÉO DA ESCOLA 
// ==========================================================

async function saveSchoolConfig(schoolName, logoBase64, schoolAddress, schoolPhone, schoolWebsite) {
    if (!auth.currentUser || !isCoordinator) return; // Apenas coordenador salva
    const config = {
        schoolName: schoolName,
        logoBase64: logoBase64 || '',
        schoolAddress: schoolAddress || '',
        schoolPhone: schoolPhone || '',
        schoolWebsite: schoolWebsite || ''
    };
    try {
        await configDocRef.set(config, { merge: true });
        console.log("Configura√ß√µes da escola salvas no Firebase.");
    } catch (e) {
        console.error("Erro ao salvar configura√ß√µes da escola no Firebase: ", e);
    }
}

async function loadSchoolConfig() {
    if (!auth.currentUser) return null; 
    try {
        const doc = await configDocRef.get();
        if (doc.exists) {
            applySavedLogo(doc.data());
            return doc.data();
        }
    } catch (e) {
        console.error("Erro ao carregar configura√ß√µes da escola do Firebase: ", e);
    }
    return null;
}

function applySavedLogo(config) {
    const logoPreview = document.getElementById('logoPreview');
    const logoPlaceholder = document.getElementById('logoPlaceholder');
    const schoolNameInput = document.getElementById('schoolName');
    const schoolAddressInput = document.getElementById('schoolAddress');
    const schoolPhoneInput = document.getElementById('schoolPhone');
    const schoolWebsiteInput = document.getElementById('schoolWebsite');

    if (config) {
        // Atualiza os campos
        if (config.schoolName) { schoolNameInput.value = config.schoolName; }
        if (config.schoolAddress) { schoolAddressInput.value = config.schoolAddress; }
        if (config.schoolPhone) { schoolPhoneInput.value = config.schoolPhone; }
        if (config.schoolWebsite) { schoolWebsiteInput.value = config.schoolWebsite; }

        if (config.logoBase64 && config.logoBase64.startsWith('data:image')) {
            logoPreview.src = config.logoBase64;
            logoPreview.style.display = 'block';
            logoPlaceholder.style.display = 'none';
            document.getElementById('logoText').textContent = 'Logo salva (Clique para remover)';
            return; 
        }
    }
    
    logoPreview.src = '';
    logoPreview.style.display = 'none';
    logoPlaceholder.style.display = 'block';
    document.getElementById('logoText').textContent = 'Logo da Escola';
}

async function updateSchoolConfigFromForm() {
    if (!auth.currentUser || !isCoordinator) return;
    const logoPreview = document.getElementById('logoPreview');
    // Usa o src da preview, que pode ser Base64 ou vazio
    const logoData = logoPreview.style.display !== 'none' && logoPreview.src.startsWith('data:image') 
                             ? logoPreview.src 
                             : ''; 
    await saveSchoolConfig(
        document.getElementById('schoolName').value,
        logoData,
        document.getElementById('schoolAddress').value,
        document.getElementById('schoolPhone').value,
        document.getElementById('schoolWebsite').value
    );
}

async function handleLogoUpload() {
    if (!auth.currentUser || !isCoordinator) {
        alert("Apenas coordenadores podem fazer upload/alterar a logo.");
        return;
    }

    const fileInput = document.getElementById('logoUpload');
    const file = fileInput.files[0];
    
    if (file) {
        const reader = new FileReader();
        reader.onload = async function (e) {
            const logoBase64 = e.target.result;
            const logoPreview = document.getElementById('logoPreview');
            const logoPlaceholder = document.getElementById('logoPlaceholder');
            logoPreview.src = logoBase64;
            logoPreview.style.display = 'block';
            logoPlaceholder.style.display = 'none';
            document.getElementById('logoText').textContent = 'Logo carregada e salva automaticamente';
            await updateSchoolConfigFromForm(); // Salva no Firestore
        };
        reader.readAsDataURL(file);
    } else {
        // Limpa a logo
        await saveSchoolConfig(
             document.getElementById('schoolName').value,
             '',
             document.getElementById('schoolAddress').value,
             document.getElementById('schoolPhone').value,
             document.getElementById('schoolWebsite').value
        );
        const config = await loadSchoolConfig();
        applySavedLogo(config);
    }
    fileInput.value = '';
}


// ==========================================================
// 4. FUN√á√ïES DE RELAT√ìRIO (GET, SET, SAVE, LIST)
// ==========================================================

function getReportDataFromForm() {
    const logoPreview = document.getElementById('logoPreview');
    const logoData = logoPreview.style.display !== 'none' && logoPreview.src.startsWith('data:image') 
                             ? logoPreview.src 
                             : ''; 

    const reportData = {
        // Info da Escola (Campos desabilitados, mas lidos para o PDF)
        schoolName: document.getElementById('schoolName').value,
        schoolAddress: document.getElementById('schoolAddress').value, 
        schoolPhone: document.getElementById('schoolPhone').value, 
        schoolWebsite: document.getElementById('schoolWebsite').value, 
        logoBase64: logoData, // Inclui a logo Base64

        // Info do Aluno/Professor/Relat√≥rio
        studentName: document.getElementById('studentName').value,
        studentAge: document.getElementById('studentAge').value,
        studentGrade: document.getElementById('studentGrade').value,
        schoolYear: document.getElementById('schoolYear').value,
        teacherName: document.getElementById('teacherName').value,
        otherTeachers: document.getElementById('otherTeachers').value,
        digitalSignatureText: document.getElementById('digitalSignatureText').value, 
        
        // Campos de Experi√™ncia
        devEuOutroNos: document.getElementById('devEuOutroNos').value,
        devEscutaFala: document.getElementById('devEscutaFala').value,
        devEspacoTempo: document.getElementById('devEspacoTempo').value,
        devCorpoGesto: document.getElementById('devCorpoGesto').value,
        devTracosSons: document.getElementById('devTracosSons').value,
        
        // Observa√ß√µes Adicionais
        improvements: document.getElementById('improvements').value,
        generalObservations: document.getElementById('generalObservations').value,
    };

    return reportData;
}
    
function validateForm() {
    const requiredFields = [
          'studentName', 'studentAge', 
          'studentGrade', 'schoolYear', 'teacherName', 'schoolName'
    ];
    
    let isValid = true;
    for (let fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        field.classList.remove('is-invalid');
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } 
    }
    
    if (!isValid) {
        alert('Por favor, preencha todos os campos obrigat√≥rios marcados com *!');
    }
    
    return isValid;
}

function createReportListItem(report) {
    const timestampText = report.data_atualizacao ? 
        new Date(report.data_atualizacao.toDate()).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 
        'Data Desconhecida';
        
    const item = document.createElement('div');
    item.className = 'report-item';
    item.dataset.id = report.id;
    item.innerHTML = `
        <div style="flex-grow: 1;">
            <strong class="text-primary">${report.studentName}</strong> 
            <small class="text-muted">(${report.studentGrade || 'S/ Turma'})</small>
            <br>
            <small class="text-secondary">√öltima atualiza√ß√£o: ${timestampText}</small>
        </div>
        <div>
            <button class="btn btn-sm btn-info text-white me-2 load-report-btn" data-id="${report.id}" title="Carregar para Edi√ß√£o">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                  <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.642a.5.5 0 0 1 .707 0l1.293 1.294zm-2.5 4.394-2-2L4.254 13.04a.5.5 0 0 0 .144.148l8.36 1.832a.5.5 0 0 0 .58-.456V6.334z"/>
                </svg>
            </button>
            <button class="btn btn-sm btn-danger delete-report-btn" data-id="${report.id}" title="Apagar Permanentemente">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                  <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h9.5a1 1 0 0 1 1 1v1zM4 4h8v9a1 1 0 0 0 1-1V5H3v8a1 1 0 0 0 1-1V4zM12 4H4V3h8v1z"/>
                </svg>
            </button>
        </div>
    `;
    return item;
}

function updateSavedReportsDisplay(reportsToDisplay) {
    const list = document.getElementById('savedReportsList');
    const countSpan = document.getElementById('savedReportsCount');
    const noReportsMessage = document.getElementById('noReportsMessage');

    list.innerHTML = ''; // Limpa a lista atual
    countSpan.textContent = relatoriosCache.length; // Conta no total
    
    if (reportsToDisplay.length === 0) {
        noReportsMessage.style.display = 'block';
    } else {
        noReportsMessage.style.display = 'none';
        reportsToDisplay.forEach(report => {
            list.appendChild(createReportListItem(report));
        });
    }
    
    // Adiciona Listeners aos bot√µes gerados dinamicamente
    list.querySelectorAll('.load-report-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const reportId = e.currentTarget.dataset.id;
            const report = relatoriosCache.find(r => r.id === reportId);
            if (report) fillFormWithReport(report);
        });
    });

    list.querySelectorAll('.delete-report-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const reportId = e.currentTarget.dataset.id;
            deleteReport(reportId);
        });
    });
}

async function getAndCacheReports() {
    if (!auth.currentUser) return;

    let query = reportsCollection;
    
    if (isCoordinator) {
        // Coordenador: V√™ todos, ordenados por nome do aluno.
        query = query.orderBy('studentName', 'asc');
    } else {
        // Professor: V√™ apenas os dele.
        query = query
            .where('professor_id', '==', auth.currentUser.uid)
            .orderBy('data_atualizacao', 'desc');
    }
    
    try {
        const snapshot = await query.get();
        relatoriosCache = []; 
        snapshot.forEach(doc => {
            relatoriosCache.push({ id: doc.id, ...doc.data() });
        });
        
        // Atualiza a lista com o cache completo (antes da busca)
        updateSavedReportsDisplay(relatoriosCache);
        
    } catch (e) {
        console.error("Erro ao carregar relat√≥rios do Firestore:", e);
        document.getElementById('savedReportsCount').textContent = 'ERRO';
        document.getElementById('noReportsMessage').textContent = 'Erro ao carregar relat√≥rios. Verifique o console do navegador e os √≠ndices/regras do Firebase.';
        document.getElementById('noReportsMessage').style.display = 'block';
    }
}

async function saveReportToFirebase() {
    if (!auth.currentUser || !validateForm()) {
        return;
    }

    const reportData = getReportDataFromForm();
    
    // Metadados do Firebase
    reportData.professor_id = auth.currentUser.uid; 
    reportData.data_atualizacao = firebase.firestore.FieldValue.serverTimestamp(); 
    reportData.timestamp = new Date().toLocaleString('pt-BR'); 

    // Padroniza a turma
    reportData.studentGrade = reportData.studentGrade.toUpperCase().trim(); 

    let docId = document.getElementById('saveReport').dataset.id;

    try {
        if (docId && docId !== 'NEW_REPORT_ID' && docId.length > 10) {
            // Edi√ß√£o
            await reportsCollection.doc(docId).set(reportData, { merge: true });
            alert(`Relat√≥rio do(a) aluno(a) ${reportData.studentName} atualizado com sucesso no servidor!`);
        } else {
            // Cria√ß√£o
            const docRef = await reportsCollection.add(reportData);
            docId = docRef.id;
            document.getElementById('saveReport').dataset.id = docId;
            alert(`Relat√≥rio do(a) aluno(a) ${reportData.studentName} salvo com sucesso no servidor!`);
        }
        
        await getAndCacheReports(); // Recarrega a lista
        
        return docId;

    } catch (e) {
        console.error("Erro ao salvar relat√≥rio no Firebase: ", e);
        alert("Erro ao salvar relat√≥rio. Verifique sua conex√£o e permiss√µes do Firebase/Firestore.");
    }
}

async function deleteReport(reportId) {
    if (!confirm("Tem certeza que deseja apagar permanentemente este relat√≥rio? Esta a√ß√£o n√£o pode ser desfeita.")) return;

    try {
        await reportsCollection.doc(reportId).delete();
        alert("Relat√≥rio apagado com sucesso.");
        await getAndCacheReports(); // Recarrega a lista
        
        // Se estiver editando o relat√≥rio apagado, reseta o formul√°rio
        if (document.getElementById('saveReport').dataset.id === reportId) {
            document.getElementById('reportForm').reset();
            document.getElementById('saveReport').dataset.id = '';
            applySavedLogo(await loadSchoolConfig()); // Recarrega a logo da config padr√£o
        }

    } catch (e) {
        console.error("Erro ao apagar relat√≥rio:", e);
        alert("Erro ao apagar relat√≥rio. Verifique sua conex√£o e permiss√µes.");
    }
}

async function clearAllReports() {
    if (!isCoordinator) return;
    if (!confirm("ALERTA M√ÅXIMO: Voc√™ est√° prestes a APAGAR TODOS OS RELAT√ìRIOS salvos por TODOS os professores. Deseja continuar?")) return;

    try {
        // Obter todos os documentos
        const snapshot = await reportsCollection.get();
        const batch = db.batch();

        snapshot.forEach((doc) => {
            batch.delete(reportsCollection.doc(doc.id));
        });

        await batch.commit();
        alert(`Todos os ${snapshot.size} relat√≥rios foram apagados com sucesso.`);
        await getAndCacheReports();

    } catch (e) {
        console.error("Erro ao apagar todos os relat√≥rios:", e);
        alert("Erro ao apagar todos os relat√≥rios. Verifique o console.");
    }
}

async function fillFormWithReport(report) {
    document.getElementById('saveReport').dataset.id = report.id; 
    
    const currentConfig = await loadSchoolConfig();
    document.getElementById('schoolName').value = report.schoolName || currentConfig?.schoolName || '';
    document.getElementById('schoolAddress').value = report.schoolAddress || currentConfig?.schoolAddress || '';
    document.getElementById('schoolPhone').value = report.schoolPhone || currentConfig?.schoolPhone || '';
    document.getElementById('schoolWebsite').value = report.schoolWebsite || currentConfig?.schoolWebsite || '';
    
    document.getElementById('studentName').value = report.studentName || '';
    document.getElementById('studentAge').value = report.studentAge || '';
    document.getElementById('studentGrade').value = report.studentGrade || '';
    document.getElementById('schoolYear').value = report.schoolYear || '';
    document.getElementById('teacherName').value = report.teacherName || '';
    document.getElementById('otherTeachers').value = report.otherTeachers || '';
    document.getElementById('digitalSignatureText').value = report.digitalSignatureText || ''; 
    document.getElementById('improvements').value = report.improvements || '';
    document.getElementById('generalObservations').value = report.generalObservations || '';
    
    document.getElementById('devEuOutroNos').value = report.devEuOutroNos || '';
    document.getElementById('devEscutaFala').value = report.devEscutaFala || '';
    document.getElementById('devEspacoTempo').value = report.devEspacoTempo || '';
    document.getElementById('devCorpoGesto').value = report.devCorpoGesto || '';
    document.getElementById('devTracosSons').value = report.devTracosSons || '';
    
    if(report.logoBase64 && report.logoBase64.startsWith('data:image')) {
        applySavedLogo({ logoBase64: report.logoBase64 });
    } else {
        applySavedLogo(currentConfig);
    }

    const createTabButton = document.getElementById('create-tab');
    bootstrap.Tab.getInstance(createTabButton)?.show();
    alert(`Relat√≥rio do(a) aluno(a) ${report.studentName} carregado para edi√ß√£o. Lembre-se de clicar em "Salvar Relat√≥rio" para manter as altera√ß√µes.`);
}

function filterReports(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    if (!term) {
        updateSavedReportsDisplay(relatoriosCache);
        return;
    }
    
    const filtered = relatoriosCache.filter(report => {
        const name = report.studentName ? report.studentName.toLowerCase() : '';
        const grade = report.studentGrade ? report.studentGrade.toLowerCase() : '';
        return name.includes(term) || grade.includes(term);
    });
    
    updateSavedReportsDisplay(filtered);
}

function loadAppContent() {
    // 1. Carrega as configura√ß√µes da escola e a logo
    loadSchoolConfig(); 
    
    // 2. Carrega e exibe a lista de relat√≥rios
    getAndCacheReports();
}

// ==========================================================
// 5. L√ìGICA DE GERA√á√ÉO E RENDERIZA√á√ÉO DE PDF (OTIMIZADA PARA MOBILE)
// ==========================================================

// Fun√ß√£o CR√çTICA: Cria o HTML limpo e formatado do relat√≥rio (o que ser√° transformado em PDF)
function generateReportHTML(data) {
    // 1. Cria o cont√™iner principal do PDF com estilos b√°sicos de relat√≥rio
    const reportContainer = document.createElement('div');
    // ID tempor√°rio para a captura
    reportContainer.id = 'relatorio-pronto-para-pdf'; 
    // Estilos internos essenciais para layout do PDF
    reportContainer.style.padding = '20mm'; 
    reportContainer.style.fontFamily = 'Arial, sans-serif';
    reportContainer.style.fontSize = '12pt';
    reportContainer.style.color = '#333';
    reportContainer.style.lineHeight = '1.5';

    // 2. Cabe√ßalho (Logo e Info da Escola)
    let headerHTML = `
        <div style="border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
            <div style="flex-grow: 1;">
                <h1 style="font-size: 16pt; color: #007bff; margin: 0;">Relat√≥rio Individual de Avalia√ß√£o Descritiva</h1>
                <p style="font-size: 10pt; margin: 0; color: #555;">${data.schoolYear} - ${data.studentGrade}</p>
                <p style="font-size: 10pt; margin: 0; color: #555;">${data.schoolName} - ${data.schoolAddress}</p>
                <p style="font-size: 10pt; margin: 0; color: #555;">${data.schoolPhone} | ${data.schoolWebsite}</p>
            </div>
    `;
    if (data.logoBase64) {
        // Reduz o tamanho da imagem no PDF para evitar estouro em p√°ginas A4
        headerHTML += `<img src="${data.logoBase64}" style="max-height: 80px; width: auto; margin-left: 20px;">`;
    }
    headerHTML += `</div>`;
    reportContainer.innerHTML = headerHTML;
    
    // 3. Informa√ß√µes do Aluno
    reportContainer.innerHTML += `
        <div style="margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; border-radius: 5px;">
            <h2 style="font-size: 14pt; color: #212529; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 0;">Informa√ß√µes do Aluno</h2>
            <p style="margin: 5px 0;"><strong>Nome do Aluno:</strong> ${data.studentName}</p>
            <p style="margin: 5px 0;"><strong>Idade/Anos:</strong> ${data.studentAge}</p>
            <p style="margin: 5px 0;"><strong>Professor(a):</strong> ${data.teacherName}</p>
        </div>
    `;

    // 4. Se√ß√µes de Desenvolvimento (Campos de Experi√™ncia)
    const sectionTitleStyle = "font-size: 13pt; color: #28a745; margin-top: 20px; border-bottom: 1px dashed #28a745; padding-bottom: 3px;";
    
    const developmentFields = [
        { label: "O Eu, O Outro e o N√≥s", dataKey: 'devEuOutroNos' },
        { label: "Escuta, Fala, Pensamento e Imagina√ß√£o", dataKey: 'devEscutaFala' },
        { label: "Espa√ßo, Tempo, Quantidade, Rela√ß√µes e Transforma√ß√µes", dataKey: 'devEspacoTempo' },
        { label: "Corpo, Gesto e Movimento", dataKey: 'devCorpoGesto' },
        { label: "Tra√ßos, Sons, Cores e Formas", dataKey: 'devTracosSons' }
    ];

    developmentFields.forEach(field => {
        if (data[field.dataKey] && data[field.dataKey].trim()) {
            reportContainer.innerHTML += `
                <h3 style="${sectionTitleStyle}">${field.label}</h3>
                <p style="text-align: justify; margin-top: 10px; white-space: pre-wrap;">${data[field.dataKey]}</p>
            `;
        }
    });
    
    // 5. Observa√ß√µes/Recomenda√ß√µes
    if (data.improvements && data.improvements.trim()) {
        reportContainer.innerHTML += `
            <h3 style="font-size: 13pt; color: #ffc107; margin-top: 30px; border-bottom: 1px dashed #ffc107; padding-bottom: 3px;">√Åreas que Necessitam de Maior Aten√ß√£o e Apoio (Recomenda√ß√µes)</h3>
            <p style="text-align: justify; margin-top: 10px; white-space: pre-wrap;">${data.improvements}</p>
        `;
    }
    
    if (data.generalObservations && data.generalObservations.trim()) {
        reportContainer.innerHTML += `
            <h3 style="font-size: 13pt; color: #6c757d; margin-top: 30px; border-bottom: 1px dashed #6c757d; padding-bottom: 3px;">Observa√ß√µes Gerais</h3>
            <p style="text-align: justify; margin-top: 10px; white-space: pre-wrap;">${data.generalObservations}</p>
        `;
    }
    
    // 6. Rodap√© e Assinatura
    const date = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
    reportContainer.innerHTML += `
        <div style="margin-top: 50px; text-align: center;">
            <p style="margin-bottom: 40px; font-size: 11pt;">Catu/BA, ${date}</p>
            
            <div style="display: flex; justify-content: space-around; font-size: 11pt;">
                <div style="width: 40%; text-align: center;">
                    <hr style="border-top: 1px solid #333; margin-bottom: 5px;">
                    <p style="margin: 0;"><strong>${data.teacherName}</strong></p>
                    <p style="margin: 0; font-size: 10pt; color: #555;">Professor(a) - ${data.digitalSignatureText}</p>
                </div>
                <div style="width: 40%; text-align: center;">
                    <hr style="border-top: 1px solid #333; margin-bottom: 5px;">
                    <p style="margin: 0;">Assinatura do Coordenador(a)</p>
                </div>
            </div>
        </div>
    `;

    return reportContainer;
}

const { jsPDF } = window.jspdf;
/**
 * Gera um PDF otimizado para dispositivos m√≥veis a partir de um elemento HTML.
 * @param {HTMLElement} elemento - O elemento HTML que cont√©m o relat√≥rio.
 * @param {string} filename - O nome do arquivo PDF a ser salvo.
 */
function gerarRelatorioPDF(elemento, filename = 'Relatorio_Gerado.pdf') {
    // 1. Prepara o elemento para captura fora da tela vis√≠vel
    elemento.style.position = 'absolute';
    elemento.style.top = '-9999px';
    document.body.appendChild(elemento);

    const options = {
        // Fator de escala aumentado para 2.5 para alta qualidade (essencial em telas de celular)
        scale: 2.5, 
        width: elemento.offsetWidth, 
        windowHeight: elemento.scrollHeight, 
        scrollY: -window.scrollY // Desliga a rolagem de tela durante a captura
    };
    
    // 2. Captura o HTML para um Canvas (Imagem)
    html2canvas(elemento, options).then(canvas => {
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        
        // 3. Cria o objeto PDF
        const pdf = new jsPDF('p', 'mm', 'a4'); 
        
        const pdfWidth = pdf.internal.pageSize.getWidth(); 
        const pdfHeight = pdf.internal.pageSize.getHeight(); 
        
        const imgWidth = canvas.width;
        const imgHeight = canvas.height;
        
        // Calcula a altura da imagem ajustada √† largura do PDF (mantendo a propor√ß√£o)
        let targetHeight = (imgHeight * pdfWidth) / imgWidth;
        
        let position = 0; 
        let heightLeft = targetHeight;
        
        // 4. Adiciona a imagem no PDF (com suporte a m√∫ltiplas p√°ginas)
        while (heightLeft >= 0) {
            pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, targetHeight);
            
            heightLeft -= pdfHeight; 
            
            if (heightLeft >= 0) {
                pdf.addPage();
                // A posi√ß√£o deve ser negativa, movendo a "vis√£o" do PDF para o pr√≥ximo bloco do canvas
                position = - (targetHeight - heightLeft); 
            }
        }
        
        // 5. Salva o arquivo
        pdf.save(filename);
        
        // 6. Limpeza e Restaura√ß√£o
        document.body.removeChild(elemento);
        
        alert(`PDF "${filename}" gerado com sucesso!`);
    }).catch(error => {
        document.body.removeChild(elemento);
        console.error("Erro na gera√ß√£o do PDF:", error);
        alert("Erro na gera√ß√£o do PDF. Tente novamente ou verifique se o seu relat√≥rio est√° muito extenso.");
    });
}


// ==========================================================
// 6. EVENT LISTENERS
// ==========================================================

// Listener de Logout
document.getElementById('logoutButton').addEventListener('click', () => {
    auth.signOut().then(() => {
        window.location.href = 'login.html';
    }).catch((error) => {
        console.error("Erro ao fazer logout:", error);
    });
});

// Listener de Gera√ß√£o de PDF
document.getElementById('generateReport').addEventListener('click', () => {
    if (!validateForm()) {
        return;
    }
    
    const reportData = getReportDataFromForm();
    const reportElement = generateReportHTML(reportData);
    
    // Nome do arquivo limpo
    const studentNameClean = reportData.studentName.replace(/[^a-zA-Z0-9_ ]/g, '').slice(0, 30);
    const gradeClean = reportData.studentGrade.replace(/[^a-zA-Z0-9_ ]/g, '').slice(0, 10);
    const filename = `${studentNameClean}_${gradeClean}.pdf`.replace(/ /g, '_');

    gerarRelatorioPDF(reportElement, filename);
});

// Listener de Salvar Relat√≥rio
document.getElementById('saveReport').addEventListener('click', saveReportToFirebase);

// Listener de Busca
document.getElementById('searchButton').addEventListener('click', () => {
    const searchTerm = document.getElementById('searchStudent').value;
    filterReports(searchTerm);
});

// Listener de Limpar Busca
document.getElementById('clearSearch').addEventListener('click', () => {
    document.getElementById('searchStudent').value = '';
    filterReports('');
});

// Listener de Busca com Enter
document.getElementById('searchStudent').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('searchButton').click();
    }
});

// Listener de Apagar Todos (Coordenador)
const clearAllBtn = document.getElementById('clearAllReports');
if (clearAllBtn) {
    clearAllBtn.addEventListener('click', clearAllReports);
}


// Listeners para a Configura√ß√£o da Escola (Salva automaticamente ao perder o foco - Apenas Coordenador)
const schoolConfigFields = ['schoolName', 'schoolAddress', 'schoolPhone', 'schoolWebsite'];
schoolConfigFields.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
        element.addEventListener('change', updateSchoolConfigFromForm); // change √© mais confi√°vel que blur/input para campos de texto
    }
});

// Listener para Upload/Limpeza da Logo
document.getElementById('logoUpload').addEventListener('change', handleLogoUpload);
document.querySelector('.logo-upload-box').addEventListener('click', async (e) => {
    const logoPreview = document.getElementById('logoPreview');
    // Se clicar na caixa e a logo j√° estiver vis√≠vel, pergunta se quer remover
    if (isCoordinator && logoPreview.style.display !== 'none' && logoPreview.src) {
        e.stopPropagation(); // Evita que o click suba e abra o seletor de arquivo
        if (confirm("Deseja remover a logo salva e usar a padr√£o?")) {
            // Chama a fun√ß√£o de upload sem arquivo para limpar
            document.getElementById('logoUpload').files = null; 
            handleLogoUpload();
        }
    }
});
</script>
</body>
</html>
