<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Relat√≥rio Individual de Avalia√ß√£o Descritiva (Educa√ß√£o Infantil/Ensino Fundamental I)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 900px;
            margin-top: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .nav-tabs .nav-link {
            font-weight: bold;
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            border-color: #dee2e6 #dee2e6 #fff;
            background-color: #fff;
        }
        .form-label.required::after {
            content: " *";
            color: red;
            font-weight: bold;
        }
        textarea {
            min-height: 120px;
            font-family: Arial, sans-serif;
        }
        /* Estilo para a pr√©-visualiza√ß√£o da logo */
        .logo-upload-box {
            border: 1px dashed #ccc;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
        .logo-preview {
            max-width: 100%;
            max-height: 80px;
            display: none; 
            margin-bottom: 5px;
        }
        .logo-placeholder {
            font-size: 30px;
            color: #6c757d;
        }
        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .report-item:last-child {
            border-bottom: none;
        }
        #savedReportsList {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="container"> 
    <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
        
        <div class="text-start">
            <h2 class="text-primary" style="margin-bottom: 0;">Gerador de Relat√≥rio Individual</h2>
            <p class="text-muted" style="font-size: 0.9em; margin-bottom: 0;">Ferramenta para Educa√ß√£o Infantil e Ensino Fundamental I</p>
        </div>
        
        <button id="logoutButton" class="btn btn-danger align-self-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-right me-1" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1-.5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 1 3.5v9A1.5 1.5 0 0 0 2.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                <path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
            </svg>
            Sair
        </button>
        
    </div>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      
     

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-tab-pane" type="button" role="tab" aria-controls="create-tab-pane" aria-selected="true">‚úçÔ∏è Criar Relat√≥rio</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="saved-tab" data-bs-toggle="tab" data-bs-target="#saved-tab-pane" type="button" role="tab" aria-controls="saved-tab-pane" aria-selected="false">üìö Relat√≥rios Salvos (<span id="savedReportsCount">0</span>)</button>
            </li>
        </ul>

        <div class="tab-content pt-3" id="myTabContent">

            <div class="tab-pane fade show active" id="create-tab-pane" role="tabpanel" aria-labelledby="create-tab" tabindex="0">
                <form id="reportForm">
                    
                    <h5 class="mt-3 mb-3 text-secondary">1. Configura√ß√£o da Escola (Salva Automaticamente)</h5>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="schoolName" placeholder="Escola Tra√ßos e Letras" required disabled>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="schoolAddress" placeholder="Catu/Ba" required disabled>
                        </div>
                        <div class="col-md-4">
                            <div class="logo-upload-box" onclick="document.getElementById('logoUpload').click()">
                                <input type="file" id="logoUpload" accept="image/*" style="display: none;">
                                <img id="logoPreview" class="logo-preview" alt="Pr√©-visualiza√ß√£o da Logo">
                                <span id="logoPlaceholder" class="logo-placeholder">üñºÔ∏è</span>
                                <small class="text-muted" id="logoText">Logo da Escola</small>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="schoolPhone" placeholder=" (71) 98200-2432" required disabled>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="schoolWebsite" placeholder="www.portaltracoseletras.com.br" required disabled>
                        </div>
                    </div>

                    <h5 class="mt-3 mb-3 text-secondary">2. Informa√ß√µes do Aluno/Professor</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="studentName" class="form-label required">Nome Completo do Aluno(a)</label>
                            <input type="text" class="form-control" id="studentName" required>
                        </div>
                        <div class="col-md-3">
                            <label for="studentAge" class="form-label required">Idade/Anos</label>
                            <input type="text" class="form-control" id="studentAge" required placeholder="Ex: 4 anos">
                        </div>
                        <div class="col-md-3">
                            <label for="studentGrade" class="form-label required">S√©rie/Turma</label>
                            <input type="text" class="form-control" id="studentGrade" required placeholder="Ex: Infantil III">
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="schoolYear" class="form-label required">Ano Letivo/Semestre</label>
                            <input type="text" class="form-control" id="schoolYear" required placeholder="Ex: 2024 / I Semestre">
                        </div>
                        <div class="col-md-4">
                            <label for="teacherName" class="form-label required">Nome do Professor(a)</label>
                            <input type="text" class="form-control" id="teacherName" required>
                        </div>
                        <div class="col-md-4">
                            <label for="digitalSignatureText" class="form-label">Texto da Assinatura Digital (Ex: Matr√≠cula, A. Profissional)</label>
                            <input type="text" class="form-control" id="digitalSignatureText" placeholder="Ex: Matr√≠cula 12345/BA">
                        </div>
                    </div>

                    <h5 class="mt-4 mb-3 text-secondary">3. Desenvolvimento: Campos de Experi√™ncia (BNCC)</h5>
                    <p class="text-muted"><small>Descreva o desenvolvimento da crian√ßa em cada campo de forma detalhada e positiva.</small></p>

                    <div class="mb-3">
                        <label for="devEuOutroNos" class="form-label">O Eu, O Outro e o N√≥s:</label>
                        <textarea class="form-control" id="devEuOutroNos" placeholder="Intera√ß√£o com pares, respeito √†s regras, autonomia, identidade."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="devEscutaFala" class="form-label">Escuta, Fala, Pensamento e Imagina√ß√£o:</label>
                        <textarea class="form-control" id="devEscutaFala" placeholder="Express√£o oral, compreens√£o de hist√≥rias, vocabul√°rio, formula√ß√£o de perguntas."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="devEspacoTempo" class="form-label">Espa√ßo, Tempo, Quantidade, Rela√ß√µes e Transforma√ß√µes:</label>
                        <textarea class="form-control" id="devEspacoTempo" placeholder="No√ß√µes espaciais e temporais, contagem, compara√ß√£o de objetos, racioc√≠nio l√≥gico-matem√°tico."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="devCorpoGesto" class="form-label">Corpo, Gesto e Movimento:</label>
                        <textarea class="form-control" id="devCorpoGesto" placeholder="Coordena√ß√£o motora ampla e fina, equil√≠brio, lateralidade, uso do corpo para expressar emo√ß√µes."></textarea>
                    </div>

                    <div class="mb-4">
                        <label for="devTracosSons" class="form-label">Tra√ßos, Sons, Cores e Formas:</label>
                        <textarea class="form-control" id="devTracosSons" placeholder="Interesse por artes visuais, m√∫sica, formas geom√©tricas, percep√ß√£o sensorial."></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label for="otherTeachers" class="form-label">Outros Professores Envolvidos (Opcional, n√£o aparece no PDF, apenas para registro)</label>
                        <input type="text" class="form-control" id="otherTeachers" placeholder="Ex: Prof. de Ingl√™s, Prof. de M√∫sica">
                    </div>

                    <h5 class="mt-4 mb-3 text-secondary">4. Observa√ß√µes Adicionais (Recomenda√ß√µes)</h5>


                    <div class="mb-3">
                        <label for="improvements" class="form-label">√Åreas que Necessitam de Maior Aten√ß√£o e Apoio (Recomenda√ß√µes):</label>
                        <textarea class="form-control" id="improvements" placeholder="Sugest√µes de interven√ß√£o em casa e na escola."></textarea>
                    </div>

                    <div class="mb-5">
                        <label for="generalObservations" class="form-label">Observa√ß√µes Gerais (Opcional):</label>
                        <textarea class="form-control" id="generalObservations" placeholder="Coment√°rios finais ou informa√ß√µes relevantes."></textarea>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                        <button type="button" class="btn btn-warning btn-lg" id="saveReport" data-id="" title="Salva o relat√≥rio no servidor para edi√ß√£o posterior.">üíæ Salvar Relat√≥rio</button>
                        <button type="button" class="btn btn-primary btn-lg" id="generateReport" title="Gera o PDF com base nos dados do formul√°rio.">üìÑ Gerar PDF</button>
                    </div>

                </form>
            </div>

            <div class="tab-pane fade" id="saved-tab-pane" role="tabpanel" aria-labelledby="saved-tab" tabindex="0">
                <h5 class="mt-3 mb-3 text-secondary">Relat√≥rios Salvos no Servidor Firebase</h5>

                <div class="row mb-3 align-items-center">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchStudent" placeholder="Buscar por Nome do Aluno ou S√©rie">
                            <button class="btn btn-outline-secondary" type="button" id="searchButton">üîé Buscar</button>
                            <button class="btn btn-outline-secondary" type="button" id="clearSearch">‚ùå Limpar</button>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-danger btn-sm" id="clearAllReports" style="display: none;" title="Apaga TODOS os relat√≥rios salvos. Cuidado!">üö® Apagar Tudo</button>
                    </div>
                </div>

                <div id="savedReportsList">
                    </div>
                
                <p id="noReportsMessage" class="text-center text-muted mt-4" style="display: none;">Nenhum relat√≥rio salvo ainda. Use o bot√£o "Salvar Relat√≥rio" na aba anterior!</p>
            </div>

        </div> <p class="text-center mt-5 text-muted"><small>Desenvolvido por Nay como ferramenta de apoio pedag√≥gico.</small></p>

    </div> 
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ==========================================================
// 1. CONFIGURA√á√ÉO E INICIALIZA√á√ÉO DO FIREBASE
// ==========================================================

const firebaseConfig = {
    apiKey: "AIzaSyCchixFInasRgOlmjPEafVYwVlGSqkqMIg", 
    authDomain: "geradorrelatoriosescola.firebaseapp.com",
    projectId: "geradorrelatoriosescola",
    storageBucket: "geradorrelatoriosescola.firebasestorage.app",
    messagingSenderId: "286288216743",
    appId: "1:286288216743:web:52ac6a1f23cdb7a4c91182"
};

const app = firebase.initializeApp(firebaseConfig);
const db = app.firestore();
const auth = app.auth(); 
const storageRef = app.storage().ref(); 

// Vari√°veis Globais
let isCoordinator = false; 
let relatoriosCache = [];
const reportsCollection = db.collection("relatorios"); 
const configDocRef = db.collection("config").doc("school_details");

// Vari√°vel de Permiss√£o (Simplificada)
let usuarioPermissao = { tipo: 'deslogado' }; 


// ==========================================================
// 2. L√ìGICA DE AUTENTICA√á√ÉO E PERMISS√ÉO
// ==========================================================

auth.onAuthStateChanged(user => {
    const appContent = document.querySelector('.container'); 
    
    if (user) {
        appContent.style.display = 'block';

        // CHECAGEM CR√çTICA DE PERFIL (Para Coordenador)
        db.collection('usuarios').doc(user.uid).get()
            .then(doc => {
                const userData = doc.data();
                usuarioPermissao = userData || { tipo: 'professor' }; // Define a permiss√£o
                
                if (userData && (userData.tipo === 'coordenador' || userData.tipo === 'admin')) {
                    isCoordinator = true;
                    
                    // 1. HABILITA EDI√á√ÉO DOS CAMPOS DA ESCOLA
                    document.getElementById('schoolName').disabled = false;
                    document.getElementById('schoolAddress').disabled = false;
                    document.getElementById('schoolPhone').disabled = false;
                    document.getElementById('schoolWebsite').disabled = false;
                    document.getElementById('logoUpload').disabled = false;
                    
                    // 2. MOSTRA BOT√ÉO DE EXCLUS√ÉO EM MASSA
                    const clearAllBtn = document.getElementById('clearAllReports');
                    if (clearAllBtn) {
                        clearAllBtn.style.display = 'inline-block';
                    }
                } else {
                    isCoordinator = false;
                    // ESCONDE BOT√ÉO DE EXCLUS√ÉO EM MASSA para professores
                    const clearAllBtn = document.getElementById('clearAllReports');
                    if (clearAllBtn) {
                        clearAllBtn.style.display = 'none';
                    }
                }
                
                // Chamada de Inicializa√ß√£o da Aplica√ß√£o
                loadAppContent(); 
            })
            .catch(error => {
                console.error("Erro ao carregar perfil do usu√°rio:", error);
                isCoordinator = false;
                loadAppContent();
            });
        
    } else {
        // Usu√°rio deslogado: redireciona
        appContent.style.display = 'none'; 
        window.location.href = 'login.html';
    }
});


// ==========================================================
// 3. FUN√á√ïES DE CONFIGURA√á√ÉO DA ESCOLA 
// ==========================================================

async function saveSchoolConfig(schoolName, logoBase64, schoolAddress, schoolPhone, schoolWebsite) {
    if (!auth.currentUser || !isCoordinator) return; // Apenas coordenador salva
    const config = {
        schoolName: schoolName,
        logoBase64: logoBase64 || '',
        schoolAddress: schoolAddress || '',
        schoolPhone: schoolPhone || '',
        schoolWebsite: schoolWebsite || ''
    };
    try {
        await configDocRef.set(config, { merge: true });
        console.log("Configura√ß√µes da escola salvas no Firebase.");
    } catch (e) {
        console.error("Erro ao salvar configura√ß√µes da escola no Firebase: ", e);
    }
}

async function loadSchoolConfig() {
    if (!auth.currentUser) return null; 
    try {
        const doc = await configDocRef.get();
        if (doc.exists) {
            applySavedLogo(doc.data());
            return doc.data();
        }
    } catch (e) {
        console.error("Erro ao carregar configura√ß√µes da escola do Firebase: ", e);
    }
    return null;
}

function applySavedLogo(config) {
    const logoPreview = document.getElementById('logoPreview');
    const logoPlaceholder = document.getElementById('logoPlaceholder');
    const schoolNameInput = document.getElementById('schoolName');
    const schoolAddressInput = document.getElementById('schoolAddress');
    const schoolPhoneInput = document.getElementById('schoolPhone');
    const schoolWebsiteInput = document.getElementById('schoolWebsite');

    if (config) {
        // Atualiza os campos
        if (config.schoolName) { schoolNameInput.value = config.schoolName; }
        if (config.schoolAddress) { schoolAddressInput.value = config.schoolAddress; }
        if (config.schoolPhone) { schoolPhoneInput.value = config.schoolPhone; }
        if (config.schoolWebsite) { schoolWebsiteInput.value = config.schoolWebsite; }

        if (config.logoBase64 && config.logoBase64.startsWith('data:image')) {
            logoPreview.src = config.logoBase64;
            logoPreview.style.display = 'block';
            logoPlaceholder.style.display = 'none';
            document.getElementById('logoText').textContent = 'Logo salva (Clique para remover)';
            return; 
        }
    }
    
    logoPreview.src = '';
    logoPreview.style.display = 'none';
    logoPlaceholder.style.display = 'block';
    document.getElementById('logoText').textContent = 'Logo da Escola';
}

async function updateSchoolConfigFromForm() {
    if (!auth.currentUser || !isCoordinator) return;
    const logoPreview = document.getElementById('logoPreview');
    // Usa o src da preview, que pode ser Base64 ou vazio
    const logoData = logoPreview.style.display !== 'none' && logoPreview.src.startsWith('data:image') 
                                 ? logoPreview.src 
                                 : ''; 
    await saveSchoolConfig(
        document.getElementById('schoolName').value,
        logoData,
        document.getElementById('schoolAddress').value,
        document.getElementById('schoolPhone').value,
        document.getElementById('schoolWebsite').value
    );
}

async function handleLogoUpload() {
    if (!auth.currentUser || !isCoordinator) {
        alert("Apenas coordenadores podem fazer upload/alterar a logo.");
        return;
    }

    const fileInput = document.getElementById('logoUpload');
    const file = fileInput.files[0];
    
    if (file) {
        const reader = new FileReader();
        reader.onload = async function (e) {
            const logoBase64 = e.target.result;
            const logoPreview = document.getElementById('logoPreview');
            const logoPlaceholder = document.getElementById('logoPlaceholder');
            logoPreview.src = logoBase64;
            logoPreview.style.display = 'block';
            logoPlaceholder.style.display = 'none';
            document.getElementById('logoText').textContent = 'Logo carregada e salva automaticamente';
            await updateSchoolConfigFromForm(); // Salva no Firestore
        };
        reader.readAsDataURL(file);
    } else {
        // Limpa a logo
        await saveSchoolConfig(
             document.getElementById('schoolName').value,
             '',
             document.getElementById('schoolAddress').value,
             document.getElementById('schoolPhone').value,
             document.getElementById('schoolWebsite').value
        );
        const config = await loadSchoolConfig();
        applySavedLogo(config);
    }
    fileInput.value = '';
}


// ==========================================================
// 4. FUN√á√ïES DE RELAT√ìRIO (GET, SET, SAVE, LIST - CORRIGIDAS)
// ==========================================================

function getReportDataFromForm() {
    const logoPreview = document.getElementById('logoPreview');
    const logoData = logoPreview.style.display !== 'none' && logoPreview.src.startsWith('data:image') 
                                 ? logoPreview.src 
                                 : ''; 

    const reportData = {
        // Info da Escola (Campos desabilitados, mas lidos para o PDF)
        schoolName: document.getElementById('schoolName').value,
        schoolAddress: document.getElementById('schoolAddress').value, 
        schoolPhone: document.getElementById('schoolPhone').value, ¬† ¬† ¬† 
        schoolWebsite: document.getElementById('schoolWebsite').value, ¬† 
        logoBase64: logoData, // Inclui a logo Base64

        // Info do Aluno/Professor/Relat√≥rio
        studentName: document.getElementById('studentName').value,
        studentAge: document.getElementById('studentAge').value,
        studentGrade: document.getElementById('studentGrade').value,
        schoolYear: document.getElementById('schoolYear').value,
        teacherName: document.getElementById('teacherName').value,
        otherTeachers: document.getElementById('otherTeachers').value,
        digitalSignatureText: document.getElementById('digitalSignatureText').value, 
        
        // Campos de Experi√™ncia
        devEuOutroNos: document.getElementById('devEuOutroNos').value,
        devEscutaFala: document.getElementById('devEscutaFala').value,
        devEspacoTempo: document.getElementById('devEspacoTempo').value,
        devCorpoGesto: document.getElementById('devCorpoGesto').value,
        devTracosSons: document.getElementById('devTracosSons').value,
        
        // Observa√ß√µes Adicionais
        improvements: document.getElementById('improvements').value,
        generalObservations: document.getElementById('generalObservations').value,
    };

    return reportData;
}
    
function validateForm() {
    const requiredFields = [
         'studentName', 'studentAge', 
         'studentGrade', 'schoolYear', 'teacherName', 'schoolName'
    ];
    
    let isValid = true;
    for (let fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        field.classList.remove('is-invalid');
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } 
    }
    
    if (!isValid) {
        alert('Por favor, preencha todos os campos obrigat√≥rios marcados com *!');
    }
    
    return isValid;
}

// CORRE√á√ÉO CR√çTICA: L√ìGICA DE FILTRAGEM E ATUALIZA√á√ÉO DO DISPLAY
async function getAndCacheReports() {
    if (!auth.currentUser) return;

    let query = reportsCollection;
    
    // VERIFICA SE √â COORDENADOR/ADMIN PARA EXECUTAR A CONSULTA COMPLETA
    if (isCoordinator) {
        // Coordenador: V√™ todos, ordenados por nome do aluno.
        // ATEN√á√ÉO: Se esta consulta falhar, voc√™ precisar√° CRIAR um √≠ndice 'studentName' no Firebase.
        query = query.orderBy('studentName', 'asc');
    } else {
        // Professor: V√™ apenas os dele.
        // FILTRO PELO ID do professor autenticado.
        // Ordena pela data de atualiza√ß√£o (mais recente primeiro) - Consulta simples, evita erro de √≠ndice composto.
        query = query
            .where('professor_id', '==', auth.currentUser.uid)
            .orderBy('data_atualizacao', 'desc');
    }
    
    try {
        const snapshot = await query.get();
        relatoriosCache = []; 
        snapshot.forEach(doc => {
            relatoriosCache.push({ id: doc.id, ...doc.data() });
        });
        console.log(`Relat√≥rios carregados para o cache: ${relatoriosCache.length}`);
        
        // CORRE√á√ÉO: Chama a atualiza√ß√£o da interface AQUI ap√≥s o carregamento bem-sucedido
        updateSavedReportsDisplay(relatoriosCache);
        
    } catch (e) {
        console.error("Erro ao carregar relat√≥rios do Firestore. Poss√≠vel falta de √çndice Composto: ", e);
        document.getElementById('savedReportsCount').textContent = 'ERRO';
        document.getElementById('noReportsMessage').textContent = 'Erro ao carregar relat√≥rios. Verifique o console do navegador e os √≠ndices/regras do Firebase.';
        document.getElementById('noReportsMessage').style.display = 'block';
    }
}

async function saveReportToFirebase() {
    if (!auth.currentUser || !validateForm()) {
        return;
    }

    const reportData = getReportDataFromForm();
    
    // Metadados do Firebase
    reportData.professor_id = auth.currentUser.uid; 
    reportData.data_atualizacao = firebase.firestore.FieldValue.serverTimestamp(); // Campo usado na ordena√ß√£o corrigida
    reportData.timestamp = new Date().toLocaleString('pt-BR'); 

    // Padroniza a turma
    reportData.studentGrade = reportData.studentGrade.toUpperCase().trim(); 

    let docId = document.getElementById('saveReport').dataset.id;

    try {
        if (docId && docId !== 'NEW_REPORT_ID' && docId.length > 10) {
            // Edi√ß√£o
            await reportsCollection.doc(docId).set(reportData, { merge: true });
            alert(`Relat√≥rio do(a) aluno(a) ${reportData.studentName} atualizado com sucesso no servidor!`);
        } else {
            // Cria√ß√£o
            const docRef = await reportsCollection.add(reportData);
            docId = docRef.id;
            document.getElementById('saveReport').dataset.id = docId;
            alert(`Relat√≥rio do(a) aluno(a) ${reportData.studentName} salvo com sucesso no servidor!`);
        }
        
        // Recarrega apenas os relat√≥rios vis√≠veis para o usu√°rio atual e atualiza a lista
        await getAndCacheReports();
        
        return docId;

    } catch (e) {
        console.error("Erro ao salvar relat√≥rio no Firebase: ", e);
        alert("Erro ao salvar relat√≥rio. Verifique sua conex√£o e permiss√µes do Firebase/Firestore.");
    }
}

async function fillFormWithReport(report) {
    document.getElementById('saveReport').dataset.id = report.id; 
    
    const currentConfig = await loadSchoolConfig();
    document.getElementById('schoolName').value = report.schoolName || currentConfig?.schoolName || '';
    document.getElementById('schoolAddress').value = report.schoolAddress || currentConfig?.schoolAddress || '';
    document.getElementById('schoolPhone').value = report.schoolPhone || currentConfig?.schoolPhone || '';
    document.getElementById('schoolWebsite').value = report.schoolWebsite || currentConfig?.schoolWebsite || '';
    
    document.getElementById('studentName').value = report.studentName || '';
    document.getElementById('studentAge').value = report.studentAge || '';
    document.getElementById('studentGrade').value = report.studentGrade || '';
    document.getElementById('schoolYear').value = report.schoolYear || '';
    document.getElementById('teacherName').value = report.teacherName || '';
    document.getElementById('otherTeachers').value = report.otherTeachers || '';
    document.getElementById('digitalSignatureText').value = report.digitalSignatureText || ''; 
    document.getElementById('improvements').value = report.improvements || '';
    document.getElementById('generalObservations').value = report.generalObservations || '';
    
    document.getElementById('devEuOutroNos').value = report.devEuOutroNos || '';
    document.getElementById('devEscutaFala').value = report.devEscutaFala || '';
    document.getElementById('devEspacoTempo').value = report.devEspacoTempo || '';
    document.getElementById('devCorpoGesto').value = report.devCorpoGesto || '';
    document.getElementById('devTracosSons').value = report.devTracosSons || '';
    
    if(report.logoBase64 && report.logoBase64.startsWith('data:image')) {
        applySavedLogo({ logoBase64: report.logoBase64 });
    } else {
        applySavedLogo(currentConfig);
    }

    const createTabButton = document.getElementById('create-tab');
    bootstrap.Tab.getInstance(createTabButton)?.show();
    alert(`Relat√≥rio do(a) aluno(a) ${report.studentName} carregado para edi√ß√£o. Lembre-se de clicar em "Salvar Relat√≥rio" para manter as altera√ß√µes.`);
}

// CORRE√á√ÉO CR√çTICA: L√ìGICA DE PERMISS√ÉO PARA EXCLUS√ÉO
async function deleteReport(id) {
    if (!auth.currentUser) return;
    
    const reportToDelete = relatoriosCache.find(r => r.id === id);
    if (!reportToDelete) {
        alert("Relat√≥rio n√£o encontrado.");
        return;
    }

    // Checagem de Permiss√£o: Coordenador/Admin PODE OU o criador do relat√≥rio PODE.
    const isOwner = reportToDelete.professor_id === auth.currentUser.uid;
    
    // Permiss√£o negada se N√ÉO for coordenador E N√ÉO for o dono
    if (!isCoordinator && !isOwner) {
         alert("Permiss√£o negada. Apenas o(a) professor(a) criador(a) ou a Coordenadoria podem excluir este relat√≥rio.");
         return;
    }
    
    if (confirm('Tem certeza que deseja EXCLUIR este relat√≥rio? Esta a√ß√£o √© irrevers√≠vel!')) {
        try {
            await reportsCollection.doc(id).delete();
            alert('Relat√≥rio exclu√≠do do Firebase com sucesso!');
            
            await getAndCacheReports();
            
            if (document.getElementById('saveReport').dataset.id === id) {
                 clearForm();
            }
            
        } catch (e) {
            console.error("Erro ao excluir relat√≥rio no Firebase: ", e);
            alert("Erro ao excluir relat√≥rio. Verifique sua conex√£o e permiss√µes do Firebase.");
        }
    }
}
    
// NOVO: Atualiza a exibi√ß√£o da lista de relat√≥rios (Agora com controle de exclus√£o)
function updateSavedReportsDisplay(reportsArray = relatoriosCache) {
    const listContainer = document.getElementById('savedReportsList');
    const countSpan = document.getElementById('savedReportsCount');
    const noReportsMessage = document.getElementById('noReportsMessage');
    listContainer.innerHTML = ''; 
    
    const finalArray = reportsArray || relatoriosCache; 

    if (finalArray.length === 0) {
        noReportsMessage.style.display = 'block';
        noReportsMessage.textContent = 'Nenhum relat√≥rio salvo ainda. Use o bot√£o "Salvar Relat√≥rio" na aba anterior!';
    } else {
        noReportsMessage.style.display = 'none';
        
        finalArray.forEach(report => {
            const item = document.createElement('div');
            item.className = 'report-item';
            
            // L√≥gica de Permiss√£o de Exclus√£o: Coordenador/Admin PODE OU √â O CRIADOR
            const canDelete = isCoordinator || (report.professor_id === auth.currentUser?.uid);
            
            const deleteButtonHtml = canDelete
                ? `<button class="btn btn-sm btn-danger delete-btn" data-id="${report.id}" title="Excluir Relat√≥rio">üóëÔ∏è Excluir</button>`
                : `<button class="btn btn-sm btn-secondary disabled" title="Permiss√£o negada (Apenas criador ou Coordenador)">üîí Excluir</button>`;
                
            item.innerHTML = `
                <div>
                    <strong>${report.studentName}</strong> - ${report.studentGrade}<br>
                    <small class="text-muted">Salvo em: ${report.timestamp}</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-info me-2 edit-btn" data-id="${report.id}" title="Carregar para Edi√ß√£o/PDF">‚úèÔ∏è Editar</button>
                    ${deleteButtonHtml}
                </div>
            `;
            listContainer.appendChild(item);
        });
        
        // Adiciona listeners para os bot√µes rec√©m-criados
        listContainer.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const reportId = e.currentTarget.dataset.id;
                const reportToEdit = relatoriosCache.find(r => r.id === reportId);
                if (reportToEdit) {
                    fillFormWithReport(reportToEdit);
                }
            });
        });

        // Adiciona listeners APENAS aos bot√µes de exclus√£o que N√ÉO est√£o desabilitados
        listContainer.querySelectorAll('.delete-btn:not(.disabled)').forEach(button => {
            button.addEventListener('click', (e) => {
                deleteReport(e.currentTarget.dataset.id);
            });
        });
    }

    countSpan.textContent = finalArray.length;
}

async function clearAllReports() {
    if (!isCoordinator) { 
        alert("Voc√™ n√£o tem permiss√£o para limpar todos os relat√≥rios.");
        return; 
    }
    
    if (confirm("ATEN√á√ÉO: Voc√™ tem certeza que deseja excluir TODOS os relat√≥rios salvos? Esta a√ß√£o √© IRREVERS√çVEL!")) {
        const batch = db.batch();
        try {
            const snapshot = await reportsCollection.get();
            snapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            
            relatoriosCache = []; // Limpa o cache local
            updateSavedReportsDisplay([]); 
            alert('Todos os relat√≥rios foram apagados do Firebase.');
            clearForm();
        } catch (e) {
            console.error("Erro ao limpar relat√≥rios do Firebase: ", e);
            alert("Erro ao limpar relat√≥rios. Verifique sua conex√£o e permiss√µes do Firebase.");
        }
    }
}
        
function handleSearchReports() {
    if (!auth.currentUser) return;
    const searchTerm = document.getElementById('searchStudent').value.toLowerCase().trim();
    const allReports = relatoriosCache; 
    
    if (searchTerm === '') {
        updateSavedReportsDisplay(allReports);
        return;
    }

    const filteredReports = allReports.filter(report => 
        report.studentName.toLowerCase().includes(searchTerm) || 
        report.studentGrade.toLowerCase().includes(searchTerm)
    );

    updateSavedReportsDisplay(filteredReports); 
}

async function clearForm() {
    document.getElementById('saveReport').dataset.id = 'NEW_REPORT_ID'; 

    // Limpa apenas os campos do relat√≥rio
    document.getElementById('reportForm').reset();
    
    // Recarrega a logo da configura√ß√£o da escola (para n√£o sumir)
    const config = await loadSchoolConfig();
    applySavedLogo(config);
    
    alert('Formul√°rio limpo para um novo relat√≥rio.');
}

// ==========================================================
// 5. FUN√á√ïES DE GERA√á√ÉO DE PDF
// ==========================================================
    
function formatTextForJsPDF(text) {
    return text.trim().split('\n').map(line => line.trim());
}

async function generatePDFWithJsPDF() {
    const { jsPDF } = window.jspdf;
    const data = getReportDataFromForm();

    if (!validateForm()) {
        return;
    }
    
    const doc = new jsPDF({
        unit: 'mm',
        format: 'a4',
        orientation: 'portrait'
    });

    const marginX = 30; 
    const contentWidth = 210 - 30 - 20; 
    const maxPageY = 297 - 20; 
    let currentY = 30; 

    doc.setFont('times', 'normal');
    doc.setFontSize(12);
    doc.setTextColor(51, 51, 51); 

    const checkPageBreak = (heightNeeded) => {
        if (currentY + heightNeeded >= maxPageY) {
            doc.addPage();
            currentY = 30; 
            doc.setFont('times', 'normal'); 
            doc.setFontSize(12);
            doc.setTextColor(51, 51, 51);
        }
    };
    
    const addSectionTitle = (title, size = 12, style = 'bold') => {
        checkPageBreak(8); 
        doc.setFont('times', style);
        doc.setFontSize(size);
        doc.text(title, 105, currentY, { align: 'center' }); 
        currentY += 8;
        doc.setFont('times', 'normal');
        doc.setFontSize(12);
    };
    
    const addDevelopmentField = (title, content) => {
        checkPageBreak(8); 
        
        doc.setFont('times', 'bold');
        doc.text(title, marginX, currentY);
        currentY += 7;
        doc.setFont('times', 'normal');

        const lines = formatTextForJsPDF(content);
        let finalY = currentY;

        if (lines.length > 0 && lines[0].trim() !== '') {
            const indent = 12.5; 
            const textWidth = contentWidth - indent;
            const lineHeight = 1.5;
            
            const fullText = lines.join('\n');
            const splitText = doc.splitTextToSize(fullText, textWidth);
            
            const textHeight = splitText.length * doc.getLineHeight() * lineHeight;
            checkPageBreak(textHeight + 5); 

            doc.text(splitText, marginX + indent, currentY, {
                align: 'justify',
                maxWidth: textWidth,
                lineHeightFactor: lineHeight,
            });
            
            finalY = currentY + textHeight;

        } else {
            doc.text('-', marginX + 12.5, currentY);
            finalY += 7;
        }
        
        currentY = finalY + 5; 
    };


    // 1. CABE√áALHO
    const centerX = 105; 
    const MAX_LOGO_WIDTH = 40;
    const MAX_LOGO_HEIGHT = 20; 
    
    if (data.logoBase64 && data.logoBase64.startsWith('data:image')) {
            
        const imageTypeMatch = data.logoBase64.match(/data:image\/(\w+);/);
        const imageType = (imageTypeMatch && imageTypeMatch[1].toUpperCase()) || 'PNG';

        const img = new Image();
        img.src = data.logoBase64;

        await new Promise((resolve) => {
            img.onload = () => resolve();
            img.onerror = () => {
                console.error("Erro ao carregar a logo para redimensionamento.");
                resolve();
            };
        });
        
        let actualWidth = img.width;
        let actualHeight = img.height;
        let ratio = 1;

        if (actualWidth > MAX_LOGO_WIDTH) {
            ratio = MAX_LOGO_WIDTH / actualWidth;
        }
        if (actualHeight * ratio > MAX_LOGO_HEIGHT) {
            ratio = MAX_LOGO_HEIGHT / actualHeight;
        }

        const finalWidth = actualWidth * ratio;
        const finalHeight = actualHeight * ratio;
        const logoX = centerX - (finalWidth / 2); 

        doc.addImage(data.logoBase64, imageType, logoX, currentY, finalWidth, finalHeight);
        currentY += finalHeight + 3; 
    } else {
        doc.setFontSize(16);
        doc.setFont('times', 'bold');
        doc.text(data.schoolName, centerX, currentY + 5, { align: 'center' });
        currentY += 15;
        doc.setFontSize(12);
        doc.setFont('times', 'normal');
    }

    doc.setFontSize(10);
    doc.setFont('times', 'normal');
    doc.text(data.schoolAddress, centerX, currentY, { align: 'center' });
    currentY += 4;
    doc.text(`Tel: ${data.schoolPhone} | ${data.schoolWebsite}`, centerX, currentY, { align: 'center' });
    currentY += 10;
    
    doc.setLineWidth(0.5);
    doc.line(marginX, currentY, marginX + contentWidth, currentY); 
    currentY += 5;


    // 2. T√çTULO E INTRODU√á√ÉO

    addSectionTitle('RELAT√ìRIO INDIVIDUAL DE AVALIA√á√ÉO DESCRITIVA', 14, 'bold');
    addSectionTitle(data.schoolYear, 12, 'normal');
    currentY += 5;
    
    checkPageBreak(15);
    doc.setFont('times', 'bold');
    doc.text(`ALUNO(A): `, marginX, currentY);
    doc.text(`IDADE: `, marginX + contentWidth * 0.5, currentY);
    currentY += 6;
    doc.setFont('times', 'normal');
    doc.text(data.studentName, marginX + 30, currentY - 6);
    doc.text(data.studentAge, marginX + contentWidth * 0.5 + 15, currentY - 6);
    
    checkPageBreak(15);
    doc.setFont('times', 'bold');
    doc.text(`S√âRIE: `, marginX, currentY);
    doc.text(`ANO/SEMESTRE: `, marginX + contentWidth * 0.5, currentY);
    currentY += 6;
    doc.setFont('times', 'normal');
    doc.text(data.studentGrade, marginX + 30, currentY - 6);
    doc.text(data.schoolYear, marginX + contentWidth * 0.5 + 40, currentY - 6);
    currentY += 5;
    
    addSectionTitle('DESENVOLVIMENTO', 14, 'bold');
    currentY += 5;

    // 3. CAMPOS DE EXPERI√äNCIA 

    addSectionTitle('CAMPOS DE EXPERI√äNCIA (BNCC)', 12, 'bold');
    currentY += 3;

    addDevelopmentField('O Eu, O Outro e o N√≥s:', data.devEuOutroNos);
    addDevelopmentField('Escuta, Fala, Pensamento e Imagina√ß√£o:', data.devEscutaFala);
    addDevelopmentField('Espa√ßo, Tempo, Quantidade, Rela√ß√µes e Transforma√ß√µes:', data.devEspacoTempo);
    addDevelopmentField('Corpo, Gesto e Movimento:', data.devCorpoGesto);
    addDevelopmentField('Tra√ßos, Sons, Cores e Formas:', data.devTracosSons);

    // 4. OBSERVA√á√ïES ADICIONAIS
    
    currentY += 5;
    addSectionTitle('OBSERVA√á√ïES ADICIONAIS', 12, 'bold');
    currentY += 3;

    addDevelopmentField('√Åreas que Necessitam de Maior Aten√ß√£o e Apoio (Recomenda√ß√µes):', data.improvements);
    addDevelopmentField('Observa√ß√µes Gerais:', data.generalObservations);

    // 5. ENCERRAMENTO E ASSINATURAS

    currentY += 10;
    checkPageBreak(30);

    doc.setFont('times', 'normal');
    const currentDate = new Date().toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });
    const city = data.schoolAddress.split(',')[0].trim() || 'Catu/Ba';
    doc.text(`${city}, ${currentDate}.`, centerX, currentY, { align: 'center' });
    currentY += 20;

    checkPageBreak(40);

    const signatureY = currentY + 15;
    const signatureX = marginX + contentWidth * 0.5; 
    const signatureLineWidth = contentWidth * 0.45; 

    doc.setLineWidth(0.2);
    doc.line(signatureX - signatureLineWidth / 2, signatureY, signatureX + signatureLineWidth / 2, signatureY);

    doc.setFontSize(10);
    doc.setFont('times', 'bold');

    doc.text(data.teacherName, signatureX, signatureY + 4, { align: 'center' });

    doc.text('Professor(a) Respons√°vel', signatureX, signatureY + 8, { align: 'center' });

    if (data.digitalSignatureText) {
        doc.setFontSize(8);
        doc.setFont('times', 'normal');
        doc.text(`Assinatura Digital: ${data.digitalSignatureText}`, signatureX, signatureY + 12, { align: 'center' });
    }

    currentY = signatureY + 15; 

    const filename = `Relatorio_${data.studentName.replace(/\s+/g, '_')}_${new Date().getFullYear()}.pdf`;

    doc.save(filename);
}

// ==========================================================
// 6. FUN√á√ÉO DE INICIALIZA√á√ÉO E LISTENERS 
// ==========================================================
async function loadAppContent() {
    // 1. Inicializa√ß√£o da logo e configura√ß√µes da escola
    const savedConfig = await loadSchoolConfig();
    applySavedLogo(savedConfig);
    
    // 2. Inicializa o ID do relat√≥rio no bot√£o Salvar (para criar um novo por padr√£o)
    document.getElementById('saveReport').dataset.id = 'NEW_REPORT_ID';
    
    // 3. Atualiza o cache e o display dos relat√≥rios salvos (com permiss√£o)
    // CORRE√á√ÉO: getAndCacheReports agora chama updateSavedReportsDisplay internamente para garantir que a lista seja atualizada.
    await getAndCacheReports();
    
    // 4. Configura Listeners
    document.getElementById('saveReport').addEventListener('click', saveReportToFirebase);
    document.getElementById('generateReport').addEventListener('click', generatePDFWithJsPDF);
    document.getElementById('logoUpload').addEventListener('change', handleLogoUpload);
    document.getElementById('schoolName').addEventListener('change', updateSchoolConfigFromForm);
    document.getElementById('schoolAddress').addEventListener('change', updateSchoolConfigFromForm);
    document.getElementById('schoolPhone').addEventListener('change', updateSchoolConfigFromForm);
    document.getElementById('schoolWebsite').addEventListener('change', updateSchoolConfigFromForm);
    document.getElementById('searchButton').addEventListener('click', handleSearchReports);
    document.getElementById('searchStudent').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
            handleSearchReports();
        }
    });
    document.getElementById('clearSearch').addEventListener('click', () => {
        document.getElementById('searchStudent').value = '';
        updateSavedReportsDisplay(relatoriosCache); 
    });
    document.getElementById('clearAllReports').addEventListener('click', clearAllReports);
    
    // Listener para o bot√£o Sair
    const logoutBtn = document.getElementById('logoutButton');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
    }
}

function handleLogout() {
    auth.signOut().then(() => {
        window.location.href = 'login.html';
    }).catch((error) => {
        console.error("Erro ao sair:", error);
        alert("Ocorreu um erro ao tentar sair. Tente novamente.");
    });
}
</script>
</body>
</html>
